<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>VoxSolfejo ‚Äì FUNCIONAL</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.8.7/build/opensheetmusicdisplay.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f1f5f9;
  padding: 16px;
}
button, input {
  padding: 10px;
  font-size: 14px;
}
button:disabled {
  opacity: 0.5;
}
#score {
  background: #fff;
  padding: 8px;
  border-radius: 8px;
  margin-top: 10px;
}
#status {
  margin-top: 10px;
  font-size: 13px;
}
</style>
</head>

<body>

<h3>üéº VoxSolfejo (vers√£o que funciona)</h3>

<input type="file" id="fileInput" accept=".musicxml,.xml,.mxl">
<button id="playBtn" disabled>‚ñ∂ Play</button>
<button id="stopBtn" disabled>‚èπ Stop</button>

<div id="status">Carregue um MusicXML.</div>
<div id="score"></div>

<script>
const SOLFEJO = ["Do","Re","Mi","Fa","Sol","La","Si"];
let osmd;
let timeline = [];
let playing = false;
let stopFlag = false;

osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("score", {
  autoResize: true
});

/* ================= UPLOAD ================= */

document.getElementById("fileInput").addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;

  reset();
  setStatus("Carregando partitura...");

  try {
    const text = await file.text();
    await osmd.load(text);
    osmd.render();
    extractNotes();
  } catch (err) {
    console.error(err);
    setStatus("Erro ao carregar MusicXML.");
  }
});

/* ================= EXTRA√á√ÉO REAL ================= */

function extractNotes() {
  timeline = [];

  const measures = osmd.GraphicSheet.MeasureList;

  measures.forEach(measure => {
    measure.forEach(staffMeasure => {
      staffMeasure.staffEntries.forEach(entry => {
        const dur = entry.sourceStaffEntry?.Duration?.RealValue;
        if (!dur || dur <= 0) return;

        if (!entry.notes || entry.notes.length === 0) {
          timeline.push({ type:"rest", dur });
        } else {
          entry.notes.forEach(n => {
            const p = n.sourceNote?.Pitch;
            if (!p) return;

            const solfejo = SOLFEJO[p.FundamentalNote];
            if (!solfejo) return;

            timeline.push({
              type: "note",
              text: solfejo,
              dur
            });
          });
        }
      });
    });
  });

  if (timeline.length === 0) {
    setStatus("Nenhuma nota v√°lida encontrada.");
    return;
  }

  setStatus(`Partitura pronta (${timeline.length} eventos).`);
  document.getElementById("playBtn").disabled = false;
}

/* ================= PLAYER ================= */

document.getElementById("playBtn").onclick = async () => {
  if (playing) return;

  // üîë destrava √°udio no Chrome
  const unlock = new SpeechSynthesisUtterance(" ");
  speechSynthesis.speak(unlock);
  speechSynthesis.cancel();

  playing = true;
  stopFlag = false;
  document.getElementById("stopBtn").disabled = false;
  setStatus("Solfejando...");

  const bpm = 60;

  for (const ev of timeline) {
    if (stopFlag) break;

    const ms = ev.dur * (60000 / bpm) * 4;

    if (ev.type === "note") {
      const u = new SpeechSynthesisUtterance(ev.text);
      u.lang = "pt-BR";
      speechSynthesis.speak(u);
    }

    await wait(ms);
  }

  stop();
};

document.getElementById("stopBtn").onclick = stop;

/* ================= UTILS ================= */

function wait(ms) {
  return new Promise(r => setTimeout(r, ms));
}

function stop() {
  stopFlag = true;
  playing = false;
  speechSynthesis.cancel();
  document.getElementById("stopBtn").disabled = true;
  setStatus("Parado.");
}

function reset() {
  stop();
  timeline = [];
  document.getElementById("playBtn").disabled = true;
}

function setStatus(msg) {
  document.getElementById("status").innerText = msg;
}
</script>

</body>
</html>
