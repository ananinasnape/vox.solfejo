<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VoxSolfejo Pro | 2026</title>
    
    <!-- PWA e Estilo -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net"></script>
    
    <style>
        @import url('https://fonts.googleapis.com');
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); }
        #osmdCanvas img { margin: 0 auto; }
        .note-highlight { color: #4F46E5; transform: scale(1.2); font-weight: 800; transition: all 0.1s; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #4F46E5; cursor: pointer; }
    </style>
</head>
<body class="text-slate-900 select-none">

    <div class="max-w-5xl mx-auto min-h-screen flex flex-col p-4 md:p-8">
        
        <!-- Header Profissional -->
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-2xl font-bold text-indigo-600 tracking-tight">VoxSolfejo <span class="font-light text-slate-400">AI</span></h1>
                <p class="text-[10px] font-bold text-slate-400 tracking-widest uppercase">Padr√£o A4 = 440Hz | Fon√©tica Brasileira</p>
            </div>
            <label class="cursor-pointer bg-indigo-600 text-white px-5 py-2.5 rounded-full font-semibold shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all text-sm">
                üìÅ Abrir Partitura
                <input type="file" id="fileInput" class="hidden" accept=".xml,.musicxml,.mxl">
            </label>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 flex-1">
            
            <!-- Painel de Visualiza√ß√£o (Sheet Music) -->
            <div class="lg:col-span-2 space-y-6">
                <div class="glass-panel rounded-3xl shadow-xl border border-white p-6 min-h-[450px] flex flex-col">
                    <div id="osmdCanvas" class="w-full overflow-auto rounded-xl border border-slate-50">
                        <div id="emptyState" class="py-40 text-center text-slate-300">
                            <svg class="w-16 h-16 mx-auto mb-4 opacity-20" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a2 2 0 00-2 2v8a2 2 0 002 2h6a2 2 0 002-2V6.414A2 2 0 0016.414 5L14 2.586A2 2 0 0012.586 2H9z"/><path d="M3 8a2 2 0 012-2v10h8a2 2 0 01-2 2H5a2 2 0 01-2-2V8z"/></svg>
                            <p class="italic text-sm">Carregue um arquivo MusicXML para visualizar a partitura tradicional</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Painel de Controle e Monitor -->
            <div class="space-y-6">
                <!-- Monitor Vocal -->
                <div class="bg-indigo-600 rounded-3xl p-8 text-center shadow-xl shadow-indigo-100">
                    <span class="text-indigo-200 text-xs font-bold uppercase tracking-widest">Solfejando</span>
                    <div id="vocalDisplay" class="text-6xl font-black text-white mt-2 mb-2 h-16">--</div>
                    <div id="freqDisplay" class="text-indigo-300 font-mono text-[10px]">0.00 Hz</div>
                </div>

                <!-- Controles -->
                <div class="glass-panel rounded-3xl p-8 shadow-lg border border-white space-y-8">
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-widest">Andamento</label>
                            <span id="bpmVal" class="text-indigo-600 font-black text-lg">80 BPM</span>
                        </div>
                        <input type="range" id="bpmRange" min="30" max="180" value="80" class="w-full h-1.5 bg-slate-100 rounded-lg appearance-none">
                    </div>

                    <div class="flex gap-4">
                        <button id="playBtn" class="flex-1 bg-indigo-600 text-white py-5 rounded-2xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition-all">PLAY</button>
                        <button id="stopBtn" class="px-6 bg-slate-100 text-slate-400 py-5 rounded-2xl font-bold active:scale-95 transition-all">‚ñ†</button>
                    </div>

                    <div class="pt-4 border-t border-slate-50">
                        <p class="text-[10px] text-slate-400 leading-relaxed italic">
                            * Use arquivos MusicXML exportados do MuseScore ou Sibelius para garantir a leitura correta das pautas.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√µes T√©cnicas 2026
        const FREQUENCIAS = { 'C': 261.63, 'D': 293.66, 'E': 329.63, 'F': 349.23, 'G': 392.00, 'A': 440.00, 'B': 493.88 };
        const FONETICA = { 'C': 'D√≥', 'D': 'R√©', 'E': 'Mi', 'F': 'F√°', 'G': 'Sol', 'A': 'L√°', 'B': 'Si' };
        
        let audioCtx;
        let osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("osmdCanvas", { autoResize: true, drawTitle: false });
        let notasQueue = [];
        let rodando = false;

        // 1. Carregamento do Arquivo "Sheet Music"
        document.getElementById('fileInput').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (event) => {
                document.getElementById('emptyState').style.display = 'none';
                await osmd.load(event.target.result);
                osmd.render();
                extrairNotas();
            };
            reader.readAsText(file);
        };

        // 2. Extra√ß√£o de Dados da Partitura Visual
        function extrairNotas() {
            notasQueue = [];
            const measures = osmd.GraphicSheet.MusicPages[0].MusicSystems[0].StaffLines[0].Measures;
            
            measures.forEach(m => {
                m.StaffEntries.forEach(entry => {
                    if (entry.ModelStaffEntry.sourceNotes[0]) {
                        const pitch = entry.ModelStaffEntry.sourceNotes[0].Pitch;
                        if (pitch) {
                            const letra = "CDEFGAB"[pitch.fundamentalPitch];
                            notasQueue.push({ letra, nome: FONETICA[letra], freq: FREQUENCIAS[letra] });
                        }
                    }
                });
            });
        }

        // 3. Motor de Voz e √Åudio Neuronal
        function cantar(notaObj, tempo) {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            const filter = audioCtx.createBiquadFilter();

            // Onda Sawtooth + Filtro Bandpass simula timbre vocal
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(notaObj.freq, audioCtx.currentTime);

            filter.type = 'bandpass';
            filter.frequency.value = 600; // Frequ√™ncia m√©dia da voz

            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.1);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + tempo);

            // Fon√©tica Brasileira Articulada
            const fala = new SpeechSynthesisUtterance(notaObj.nome);
            fala.lang = 'pt-BR';
            fala.rate = 1.3;
            fala.pitch = 1;
            window.speechSynthesis.speak(fala);

            osc.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + tempo);
        }

        // 4. Loop de Execu√ß√£o
        async function iniciarSolfejo() {
            if (rodando || notasQueue.length === 0) return;
            rodando = true;
            
            const bpm = document.getElementById('bpmRange').value;
            const tempoPorNota = 60 / bpm;

            for (let nota of notasQueue) {
                if (!rodando) break;

                // Atualiza Monitor
                const vDisp = document.getElementById('vocalDisplay');
                const fDisp = document.getElementById('freqDisplay');
                vDisp.innerText = nota.nome;
                vDisp.classList.add('note-highlight');
                fDisp.innerText = nota.freq.toFixed(2) + " Hz";

                cantar(nota, tempoPorNota);

                await new Promise(r => setTimeout(r, tempoPorNota * 1000));
                vDisp.classList.remove('note-highlight');
            }
            rodando = false;
        }

        // Controles de Interface
        document.getElementById('playBtn').onclick = iniciarSolfejo;
        document.getElementById('stopBtn').onclick = () => { rodando = false; window.speechSynthesis.cancel(); };
        document.getElementById('bpmRange').oninput = (e) => {
            document.getElementById('bpmVal').innerText = e.target.value + " BPM";
        };

        // Bloqueio de sono da tela (Wake Lock 2026)
        if ('wakeLock' in navigator) { navigator.wakeLock.request('screen'); }
    </script>
</body>
</html>
