<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>üéº VoxSolfejo ‚Äì Sincronizado</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.8.9/build/opensheetmusicdisplay.min.js"></script>

<style>
body {
  font-family: Inter, system-ui, sans-serif;
  background: linear-gradient(135deg,#667eea,#764ba2);
  margin:0; padding:10px;
}
.container {
  max-width: 100%;
  margin:auto;
  background:white;
  border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
}
header {
  background:linear-gradient(135deg,#4F46E5,#7C3AED);
  color:white; padding:20px; text-align:center;
}
header h1 { margin:0; font-size:1.8rem; }
.subtitle { opacity:.9; font-size:.9rem; }
.controls-panel { padding:20px; background:#f8fafc; border-bottom:1px solid #e2e8f0; }
.file-input-wrapper { position:relative; }
input[type="file"] { position:absolute; inset:0; opacity:0; cursor:pointer; }
.file-input-button {
  padding:12px; border:2px dashed #cbd5e1; border-radius:10px;
  background:white; text-align:center; font-weight:600; color:#475569;
}
.buttons-row { display:flex; gap:10px; margin-top:15px; flex-wrap:wrap; }
button { padding:12px 20px; font-size:1rem; font-weight:700; border-radius:10px; border:none; cursor:pointer; }
button:disabled { opacity:.5; cursor:not-allowed; }
.btn-play { background:linear-gradient(135deg,#10b981,#059669); color:white; }
.btn-stop { background:linear-gradient(135deg,#ef4444,#dc2626); color:white; }
.settings-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:15px; margin-top:20px; }
.setting-item { background:white; border:1px solid #e2e8f0; border-radius:10px; padding:10px; }
.setting-item label { font-size:.8rem; font-weight:600; color:#475569; }
.value-display { margin-top:4px; font-weight:700; color:#4F46E5; font-size:.85rem; }
#status { margin:15px; padding:10px; background:#f1f5f9; border-left:4px solid #4F46E5; font-size:.9rem; }
#score { padding:10px; background:white; width:100%; min-height:300px; }
#info, #log { margin:15px; padding:10px; background:#020617; color:#e5e7eb; border-radius:10px; font-family:monospace; font-size:13px; max-height:200px; overflow-y:auto; }
.log-active { color:#4F46E5; font-weight:bold; }
</style>
</head>

<body>
<div class="container">
<header>
  <h1>üéº VoxSolfejo</h1>
  <div class="subtitle">Solfejo Musical com Voz e Partitura Sincronizados</div>
</header>

<div class="controls-panel">
  <div class="file-input-wrapper">
    <input type="file" id="fileInput" accept=".xml,.musicxml,.mxl">
    <div class="file-input-button">üì§ ESCOLHER ARQUIVO MUSICXML</div>
  </div>
  <div class="buttons-row">
    <button id="playBtn" class="btn-play" disabled>‚ñ∂Ô∏è Reproduzir</button>
    <button id="stopBtn" class="btn-stop" disabled>‚èπÔ∏è Parar</button>
  </div>
  <div class="settings-grid">
    <div class="setting-item">
      <label>BPM</label>
      <input type="number" id="bpmInput" value="80">
      <div class="value-display"><span id="bpmVal">80</span> BPM</div>
    </div>
    <div class="setting-item">
      <label>Volume</label>
      <input type="range" id="volInput" min="0" max="1" step="0.01" value="0.4">
      <div class="value-display"><span id="volVal">0.4</span></div>
    </div>
    <div class="setting-item">
      <label>Progresso</label>
      <div class="value-display"><span id="progress">0%</span></div>
    </div>
  </div>
</div>

<div id="status">‚è≥ Aguardando partitura...</div>
<div id="info"></div>
<div id="score"></div>
<div id="log"></div>

<script>
const SOLFEJO={C:{nome:"D√≥",vogal:"√≥"},D:{nome:"R√©",vogal:"√©"},E:{nome:"Mi",vogal:"i"},F:{nome:"F√°",vogal:"√°"},G:{nome:"Sol",vogal:"√≥"},A:{nome:"L√°",vogal:"√°"},B:{nome:"Si",vogal:"i"}};
const SEMI={C:-9,D:-7,E:-5,F:-4,G:-2,A:0,B:2};

let osmd, events=[], divisions=4, idx=0;
let ctx=new (window.AudioContext||window.webkitAudioContext)();
let playing=false, timer=null;

fileInput.onchange=e=>{
  const r=new FileReader();
  r.onload=()=>loadScore(r.result);
  r.readAsText(e.target.files[0]);
};

bpmInput.oninput=()=>bpmVal.textContent=bpmInput.value;
volInput.oninput=()=>volVal.textContent=volInput.value;

playBtn.onclick=play;
stopBtn.onclick=stop;

async function loadScore(xml){
  osmd ||= new opensheetmusicdisplay.OpenSheetMusicDisplay("score");
  await osmd.load(xml);
  osmd.render();
  parseXML(xml);
  playBtn.disabled=stopBtn.disabled=false;
  status.textContent="üéº Partitura carregada. Pronta para reprodu√ß√£o.";
}

function parseXML(txt){
  events=[]; idx=0; log.textContent="";
  const xml=new DOMParser().parseFromString(txt,"application/xml");
  divisions=parseInt(xml.querySelector("divisions")?.textContent||4);

  const title=xml.querySelector("work-title")?.textContent||"‚Äî";
  const bpm=xml.querySelector("sound")?.getAttribute("
