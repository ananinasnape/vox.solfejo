<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Vox Solfejo ‚Äì Funcional</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #0f172a;
  color: #e5e7eb;
  padding: 20px;
}

h1 { margin-bottom: 10px; }

.controls {
  margin-bottom: 15px;
}

button {
  padding: 10px 20px;
  font-size: 16px;
  cursor: pointer;
}

button:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

#status {
  margin-top: 10px;
  font-size: 14px;
}

#notes {
  margin-top: 20px;
  background: #020617;
  padding: 10px;
  border-radius: 6px;
  max-height: 300px;
  overflow-y: auto;
  font-family: monospace;
}
</style>
</head>

<body>

<h1>üé∂ Vox Solfejo</h1>

<div class="controls">
  <input type="file" id="fileInput" accept=".xml,.musicxml,.mxl" />
  <button id="playBtn" disabled>‚ñ∂ Play</button>
</div>

<div id="status">Carregue um MusicXML.</div>
<div id="notes"></div>

<script>
const fileInput = document.getElementById("fileInput");
const playBtn   = document.getElementById("playBtn");
const statusEl  = document.getElementById("status");
const notesEl   = document.getElementById("notes");

let events = [];
let bpm = 80;
let divisions = 4;

// Solfejo fixo (pedido seu)
const solfejo = {
  C: "Do", D: "Re", E: "Mi",
  F: "Fa", G: "Sol", A: "La", B: "Si"
};

fileInput.addEventListener("change", handleFile);
playBtn.addEventListener("click", playSequence);

function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => parseXML(reader.result);
  reader.readAsText(file);
}

function parseXML(text) {
  events = [];
  notesEl.innerHTML = "";
  playBtn.disabled = true;

  let xml;
  try {
    xml = new DOMParser().parseFromString(text, "application/xml");
  } catch {
    statusEl.textContent = "Erro ao ler XML.";
    return;
  }

  // BPM
  const tempoNode = xml.querySelector("per-minute");
  if (tempoNode) bpm = parseInt(tempoNode.textContent, 10);

  // Divisions
  const divNode = xml.querySelector("divisions");
  if (divNode) divisions = parseInt(divNode.textContent, 10);

  const noteNodes = xml.querySelectorAll("note");

  if (!noteNodes.length) {
    statusEl.textContent = "XML sem notas.";
    return;
  }

  noteNodes.forEach(note => {
    const durationNode = note.querySelector("duration");
    if (!durationNode) return;

    const duration = parseInt(durationNode.textContent, 10);

    // Pausa
    if (note.querySelector("rest")) {
      events.push({ type: "rest", duration });
      notesEl.innerHTML += "‚è∏ pausa<br>";
      return;
    }

    const pitch = note.querySelector("pitch");
    if (!pitch) return;

    const step = pitch.querySelector("step")?.textContent;
    if (!step) return;

    const name = solfejo[step] || step;

    events.push({ type: "note", name, duration });
    notesEl.innerHTML += `üéµ ${name}<br>`;
  });

  if (events.length === 0) {
    statusEl.textContent = "Nenhuma nota utiliz√°vel.";
    return;
  }

  statusEl.textContent = `Arquivo v√°lido. BPM=${bpm}`;
  playBtn.disabled = false;
}

function playSequence() {
  playBtn.disabled = true;
  statusEl.textContent = "Tocando‚Ä¶";

  let index = 0;

  function next() {
    if (index >= events.length) {
      statusEl.textContent = "Fim.";
      playBtn.disabled = false;
      return;
    }

    const ev = events[index++];
    const seconds = (60 / bpm) * (ev.duration / divisions);

    if (ev.type === "note") {
      const utter = new SpeechSynthesisUtterance(ev.name);
      utter.lang = "pt-BR";
      speechSynthesis.speak(utter);
    }

    setTimeout(next, seconds * 1000);
  }

  next();
}
</script>

</body>
</html>
