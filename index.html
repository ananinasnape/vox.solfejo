<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VoxSolfejo</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/opensheetmusicdisplay@1.8.5/build/opensheetmusicdisplay.min.js"></script>

<style>
body { background:#0f172a; color:white; }
button { touch-action: manipulation; }
</style>
</head>

<body class="p-4 max-w-4xl mx-auto space-y-4">

<h1 class="text-2xl font-black text-center">ðŸŽ¶ VoxSolfejo</h1>

<input type="file" id="fileInput" accept=".xml,.musicxml"
  class="block w-full text-sm mb-2">

<div class="flex gap-3">
  <button id="testSound"
    class="bg-green-600 px-4 py-2 rounded font-bold">
    ðŸ”Š TESTAR SOM
  </button>

  <button id="playBtn"
    class="bg-indigo-600 px-4 py-2 rounded font-bold">
    â–¶ PLAY
  </button>
</div>

<div class="flex gap-4 text-sm">
  <label>BPM
    <input type="range" id="bpm" min="40" max="200" value="80">
    <span id="bpmVal">80</span>
  </label>
</div>

<div id="score" class="bg-white text-black rounded-xl p-3"></div>

<script>
/* ================= SETUP ================= */
let audioCtx = null;
let queue = [];

const osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("score", {
  drawTitle:false,
  autoResize:true
});

const NOTAS = ['C','D','E','F','G','A','B'];
const REF = {C:-9,D:-7,E:-5,F:-4,G:-2,A:0,B:2};
const SOLFEJO = {C:'DÃ³',D:'RÃ©',E:'Mi',F:'FÃ¡',G:'Sol',A:'LÃ¡',B:'Si'};

/* ================= AUDIO TEST ================= */
document.getElementById("testSound").onclick = async () => {
  if (!audioCtx) audioCtx = new AudioContext();
  await audioCtx.resume();

  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  osc.type = "sine";
  osc.frequency.value = 440;

  gain.gain.value = 0.4;

  osc.connect(gain).connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + 0.5);
};

/* ================= LOAD XML ================= */
document.getElementById("fileInput").onchange = async e => {
  const file = e.target.files[0];
  if (!file) return;

  await osmd.load(await file.text());
  osmd.render();
  extrair();
};

/* ================= EXTRACT NOTES ================= */
function extrair() {
  queue = [];
  const sheet = osmd.GraphicSheet;

  sheet.MusicPages.forEach(p =>
    p.MusicSystems.forEach(sys =>
      sys.StaffLines.forEach(st =>
        st.Measures.forEach(m =>
          m.StaffEntries.forEach(se => {
            const src = se.ModelStaffEntry;
            const dur = src.Duration?.RealValue || 0;

            if (!src.sourceNotes?.length) {
              queue.push({tipo:'pausa', dur});
              return;
            }

            const n = src.sourceNotes[0];
            queue.push({
              tipo:'nota',
              letra: NOTAS[n.Pitch.fundamentalPitch],
              oitava: n.Pitch.octave + 3,
              acidente: n.Pitch.accidental || 0,
              dur
            });
          })
        )
      )
    )
  );
}

/* ================= FREQ ================= */
function freq(l,o,a) {
  return 440 * Math.pow(2,(REF[l]+(o-4)*12+a)/12);
}

/* ================= PLAY NOTE ================= */
async function tocar(n, tempo) {
  if (n.tipo === 'pausa') {
    return new Promise(r => setTimeout(r, tempo*1000));
  }

  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  osc.type = "triangle";
  osc.frequency.value = freq(n.letra,n.oitava,n.acidente);

  gain.gain.setValueAtTime(0, audioCtx.currentTime);
  gain.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime+0.05);
  gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime+tempo);

  osc.connect(gain).connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime+tempo);

  speechSynthesis.speak(
    new SpeechSynthesisUtterance(SOLFEJO[n.letra])
  );

  return new Promise(r => setTimeout(r, tempo*1000));
}

/* ================= PLAY ================= */
document.getElementById("playBtn").onclick = async () => {
  if (!queue.length) {
    alert("Carregue um MusicXML primeiro.");
    return;
  }

  if (!audioCtx) audioCtx = new AudioContext();
  await audioCtx.resume();

  const bpm = +document.getElementById("bpm").value;

  for (const n of queue) {
    const t = n.dur * (60/bpm) * 4;
    await tocar(n, t);
  }
};

document.getElementById("bpm").oninput = e =>
  document.getElementById("bpmVal").innerText = e.target.value;
</script>

</body>
</html>
