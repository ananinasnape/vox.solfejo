<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>VoxSolfejo ‚Äì Core Funcional</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- OSMD -->
  <script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.8.7/build/opensheetmusicdisplay.min.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f1f5f9;
      margin: 0;
      padding: 16px;
    }
    h1 {
      font-size: 1.2rem;
      margin-bottom: 8px;
    }
    #controls {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    button, input {
      padding: 10px;
      font-size: 0.9rem;
    }
    button {
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #status {
      font-size: 0.85rem;
      margin-bottom: 8px;
    }
    #score {
      background: white;
      border-radius: 8px;
      padding: 8px;
      min-height: 300px;
    }
  </style>
</head>

<body>

<h1>üéº VoxSolfejo (Core Funcional)</h1>

<div id="controls">
  <input type="file" id="fileInput" accept=".xml,.musicxml,.mxl" />
  <button id="playBtn" disabled>‚ñ∂ Play</button>
  <button id="stopBtn" disabled>‚èπ Stop</button>
</div>

<div id="status">Carregue um MusicXML para come√ßar.</div>

<div id="score"></div>

<script>
/* =========================
   CONFIGURA√á√ÉO
========================= */

const SOLFEJO = ["Do", "Re", "Mi", "Fa", "Sol", "La", "Si"];
let osmd = null;
let timeline = [];
let isPlaying = false;
let stopRequested = false;

/* =========================
   INICIALIZA√á√ÉO
========================= */

osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("score", {
  drawTitle: true,
  autoResize: true
});

/* =========================
   UPLOAD E PARSE
========================= */

document.getElementById("fileInput").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  setStatus("Carregando partitura...");
  resetPlayer();

  const text = await file.text();

  try {
    await osmd.load(text);
    osmd.render();
    buildTimeline();
  } catch (err) {
    console.error(err);
    setStatus("Erro ao carregar o MusicXML.");
  }
});

/* =========================
   CONSTRU√á√ÉO DA TIMELINE
========================= */

function buildTimeline() {
  timeline = [];

  try {
    const sheet = osmd.Sheet;
    const instruments = sheet.Instruments;

    instruments.forEach(instr => {
      instr.Staves.forEach(staff => {
        staff.Voices.forEach(voice => {
          voice.VoiceEntries.forEach(entry => {

            const duration = entry.Duration?.RealValue;
            if (!duration || duration <= 0) return;

            if (entry.Notes.length === 0) {
              timeline.push({ type: "rest", duration });
            } else {
              entry.Notes.forEach(note => {
                if (!note.Pitch) return;

                const step = note.Pitch.FundamentalNote;
                const solfejo = SOLFEJO[step];

                if (!solfejo) return;

                timeline.push({
                  type: "note",
                  text: solfejo,
                  duration
                });
              });
            }
          });
        });
      });
    });

    if (timeline.length === 0) {
      setStatus("Nenhuma nota v√°lida encontrada.");
      return;
    }

    validateTimeline();
    enablePlay();

  } catch (e) {
    console.error(e);
    setStatus("Erro ao processar a partitura.");
  }
}

/* =========================
   VALIDA√á√ÉO MUSICAL
========================= */

function validateTimeline() {
  for (let i = 0; i < timeline.length; i++) {
    const ev = timeline[i];
    if (ev.type === "note" && !ev.text) {
      throw new Error("Nota inv√°lida.");
    }
    if (ev.duration <= 0) {
      throw new Error("Dura√ß√£o inv√°lida.");
    }
  }
  setStatus(`Partitura validada. ${timeline.length} eventos prontos.`);
}

/* =========================
   PLAYER
========================= */

document.getElementById("playBtn").addEventListener("click", async () => {
  if (isPlaying || timeline.length === 0) return;

  // destrava √°udio no Chrome
  speechSynthesis.cancel();
  await speechSynthesis.getVoices();

  isPlaying = true;
  stopRequested = false;
  setStatus("Tocando solfejo...");
  document.getElementById("stopBtn").disabled = false;

  const bpm = 60;

  for (const ev of timeline) {
    if (stopRequested) break;

    const ms = ev.duration * (60000 / bpm) * 4;

    if (ev.type === "note") {
      const u = new SpeechSynthesisUtterance(ev.text);
      u.lang = "pt-BR";
      u.rate = 1;
      speechSynthesis.speak(u);
    }

    await wait(ms);
  }

  stopPlayback();
});

document.getElementById("stopBtn").addEventListener("click", () => {
  stopPlayback();
});

/* =========================
   UTILIDADES
========================= */

function wait(ms) {
  return new Promise(r => setTimeout(r, ms));
}

function stopPlayback() {
  stopRequested = true;
  isPlaying = false;
  speechSynthesis.cancel();
  document.getElementById("stopBtn").disabled = true;
  setStatus("Parado.");
}

function resetPlayer() {
  stopPlayback();
  timeline = [];
  document.getElementById("playBtn").disabled = true;
}

function enablePlay() {
  document.getElementById("playBtn").disabled = false;
}

function setStatus(msg) {
  document.getElementById("status").innerText = msg;
}
</script>

</body>
</html>
