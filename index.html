<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VoxSolfejo Maestro AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net"></script>
    <style>
        @import url('https://fonts.googleapis.com');
        body { font-family: 'Inter', sans-serif; background: #F1F5F9; }
        .glass { background: rgba(255, 255, 255, 0.96); backdrop-filter: blur(12px); }
        input[type=range] { accent-color: #4F46E5; cursor: pointer; }
        .control-label { font-size: 0.65rem; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; }
        textarea { resize: none; border: 2px solid #E2E8F0; }
        textarea:focus { border-color: #4F46E5; outline: none; }
    </style>
</head>
<body class="p-2 md:p-6 select-none">

    <div class="max-w-6xl mx-auto glass rounded-[2.5rem] shadow-2xl overflow-hidden border border-white">
        <!-- Header -->
        <header class="bg-indigo-600 p-6 text-white flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="text-center md:text-left">
                <h1 class="text-2xl font-black italic tracking-tighter uppercase">VOXSOLFEJO MAESTRO</h1>
                <p class="text-[10px] font-bold opacity-80 uppercase tracking-widest">Leitura Completa de S√≠mbolos, Ritmo e Din√¢micas</p>
            </div>
            <label class="bg-white text-indigo-600 px-6 py-2.5 rounded-full font-bold cursor-pointer hover:scale-105 transition shadow-lg text-xs">
                üìÇ ABRIR PARTITURA (PDF/XML)
                <input type="file" id="fileInput" class="hidden" accept=".xml,.musicxml,.mxl,.pdf">
            </label>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4">
            <!-- Editor de Texto -->
            <div class="p-6 bg-slate-50/80 border-r border-slate-100 flex flex-col">
                <label class="control-label mb-3 block text-center">Editor Manual (Cursor)</label>
                <textarea id="textoInput" placeholder="Ex: C D# E F G Ab B" 
                    class="w-full flex-grow p-4 rounded-2xl text-lg font-mono mb-4">C D E F G A B</textarea>
                <button id="processarTexto" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold text-[10px] uppercase tracking-widest hover:bg-black transition">
                    Interpretar Texto
                </button>
            </div>

            <!-- Visualizador Maestro -->
            <div class="lg:col-span-2 p-6 flex flex-col">
                <div id="osmdCanvas" class="w-full min-h-[350px] bg-white rounded-3xl p-4 overflow-auto border border-slate-100 shadow-inner text-center">
                    <div id="placeholder" class="py-28 text-slate-300 italic text-sm text-center">Aguardando partitura para an√°lise de s√≠mbolos...</div>
                </div>
            </div>

            <!-- Controles do M√∫sico -->
            <div class="p-6 bg-slate-50/50 border-l border-slate-100 space-y-6">
                <div class="bg-slate-900 rounded-[2rem] p-6 text-center shadow-xl border-b-4 border-indigo-500">
                    <span class="text-indigo-400 text-[10px] font-black tracking-widest uppercase">Voz / Din√¢mica</span>
                    <div id="vocalLabel" class="text-5xl font-black text-white py-1">--</div>
                    <div id="dynamicLabel" class="text-indigo-400 text-xs font-bold italic uppercase tracking-widest">mf</div>
                </div>

                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between mb-1"><label class="control-label">Velocidade (BPM)</label><span id="bpmText" class="text-indigo-600 font-black">80</span></div>
                        <input type="range" id="bpmRange" min="20" max="220" value="80" class="w-full h-1.5 bg-indigo-100 rounded-lg appearance-none">
                    </div>
                    <div>
                        <div class="flex justify-between mb-1"><label class="control-label">Transposi√ß√£o</label><span id="transposeText" class="text-indigo-600 font-black">0</span></div>
                        <input type="range" id="transposeRange" min="-12" max="12" value="0" class="w-full h-1.5 bg-indigo-100 rounded-lg appearance-none">
                    </div>
                    <div>
                        <div class="flex justify-between mb-1"><label class="control-label">Afina√ß√£o (Hz)</label><span id="baseHzText" class="text-indigo-600 font-black">440Hz</span></div>
                        <input type="range" id="baseHzRange" min="415" max="466" value="440" class="w-full h-1.5 bg-indigo-100 rounded-lg appearance-none">
                    </div>
                </div>

                <button id="playBtn" class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black text-xl shadow-xl hover:bg-indigo-700 active:scale-95 transition-all">PLAY MAESTRO</button>
                <button id="stopBtn" class="w-full py-2 bg-white text-slate-400 rounded-xl font-bold border border-slate-200 uppercase text-[10px] tracking-widest transition-all">Parar</button>
            </div>
        </div>
    </div>

    <script>
        const NOTAS_REF = { 'C': -9, 'D': -7, 'E': -5, 'F': -4, 'G': -2, 'A': 0, 'B': 2 };
        const NOMES_FONETICOS = { 'C': 'D√≥', 'D': 'R√©', 'E': 'Mi', 'F': 'F√°', 'G': 'Sol', 'A': 'L√°', 'B': 'Si' };
        
        let audioCtx, queue = [], rodando = false;
        let osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("osmdCanvas", { drawTitle: false, autoResize: true });

        // Fun√ß√£o que calcula frequ√™ncia exata incluindo ACIDENTES (# e b) e AFINA√á√ÉO BASE
        function calcularFreqCompleta(letra, oitava, acidente, transp, baseHz) {
            let semitons = NOTAS_REF[letra] + (oitava - 4) * 12 + transp;
            if (acidente === 1) semitons += 1; // Sustenido
            if (acidente === -1) semitons -= 1; // Bemol
            return baseHz * Math.pow(2, semitons / 12);
        }

        // 1. Processamento de S√≠mbolos Musicais (MusicXML / PDF)
        document.getElementById('fileInput').onchange = (e) => {
            const file = e.target.files; if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                document.getElementById('placeholder').style.display = 'none';
                await osmd.load(ev.target.result);
                osmd.render();
                extrairSimbolosMusicais();
            };
            reader.readAsText(file);
        };

        function extrairSimbolosMusicais() {
            queue = [];
            const measures = osmd.GraphicSheet.MusicPages[0].MusicSystems[0].StaffLines[0].Measures;
            measures.forEach(m => {
                m.StaffEntries.forEach(se => {
                    const source = se.ModelStaffEntry;
                    const dur = source.Duration.RealValue;
                    const dynamic = source.parentMeasure.parentSourceMeasure.printSuggestions?.dynamic || "mf";

                    if (source.sourceNotes.length > 0) {
                        const sn = source.sourceNotes[0];
                        const p = sn.Pitch;
                        queue.push({
                            tipo: 'nota',
                            letra: "CDEFGAB"[p.fundamentalPitch],
                            oitava: p.octave + 3,
                            acidente: p.accidental || 0,
                            dur: dur,
                            dinamica: dynamic,
                            articulacao: sn.articulations?.[0]?.articulationType || "normal"
                        });
                    } else {
                        queue.push({ tipo: 'pausa', dur: dur });
                    }
                });
            });
        }

        // 2. Motor de Voz Humana com Resposta a Din√¢micas e Articula√ß√µes
        function cantarMaestro(item, tempoReal) {
            if (!audioCtx) audioCtx = new AudioContext();
            const baseHz = parseInt(document.getElementById('baseHzRange').value);
            const transp = parseInt(document.getElementById('transposeRange').value);

            if (item.tipo === 'nota') {
                const freq = calcularFreqCompleta(item.letra, item.oitava, item.acidente, transp, baseHz);
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);

                // Ajuste de Volume baseado na Din√¢mica (pp, f, ff...)
                let vol = 0.3;
                if (item.dinamica.includes('f')) vol = 0.6;
                if (item.dinamica.includes('p')) vol = 0.15;

                // Ajuste de Dura√ß√£o baseado na Articula√ß√£o (Staccato)
                let durEfetiva = tempoReal;
                if (item.articulacao === "staccato") durEfetiva = tempoReal * 0.4;

                gain.gain.setValueAtTime(0, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(vol, audioCtx.currentTime + 0.05);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + durEfetiva);

                const fala = new SpeechSynthesisUtterance(NOMES_FONETICOS[item.letra]);
                fala.lang = 'pt-BR'; fala.rate = 1.3;
                window.speechSynthesis.speak(fala);

                document.getElementById('vocalLabel').innerText = NOMES_FONETICOS[item.letra] + (item.acidente === 1 ? "#" : item.acidente === -1 ? "b" : "");
                document.getElementById('dynamicLabel').innerText = item.dinamica;

                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(); osc.stop(audioCtx.currentTime + durEfetiva);
            } else {
                document.getElementById('vocalLabel').innerText = "‚Äî";
                document.getElementById('dynamicLabel').innerText = "pausa";
            }
        }

        // 3. Loop de Execu√ß√£o Maestro
        async function play() {
            if (rodando || queue.length === 0) return;
            rodando = true; if (audioCtx) await audioCtx.resume();
            for (let item of queue) {
                if (!rodando) break;
                const bpm = document.getElementById('bpmRange').value;
                const tempoNota = item.dur * (60 / bpm) * 4;
                cantarMaestro(item, tempoNota);
                await new Promise(r => setTimeout(r, tempoNota * 1000));
            }
            rodando = false;
        }

        // Eventos e UI
        document.getElementById('processarTexto').onclick = () => {
            const texto = document.getElementById('textoInput').value.toUpperCase();
            const matches = texto.match(/([A-G][#b]?)/g);
            if (matches) {
                queue = matches.map(m => ({
                    letra: m[0],
                    acidente: m.includes('#') ? 1 : m.includes('b') ? -1 : 0,
                    oitava: 4, dur: 1, tipo: 'nota', dinamica: 'mf', articulacao: 'normal'
                }));
                alert(matches.length + " notas carregadas via Editor.");
            }
        };

        document.getElementById('playBtn').onclick = play;
        document.getElementById('stopBtn').onclick = () => { rodando = false; window.speechSynthesis.cancel(); };
        document.getElementById('bpmRange').oninput = (e) => document.getElementById('bpmText').innerText = e.target.value;
        document.getElementById('transposeRange').oninput = (e) => document.getElementById('transposeText').innerText = e.target.value;
        document.getElementById('baseHzRange').oninput = (e) => document.getElementById('baseHzText').innerText = e.target.value + "Hz";
    </script>
</body>
</html>
