<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>üéº VoxSolfejo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.8.9/build/opensheetmusicdisplay.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f5f5f5;
  color: #111;
  padding: 12px;
}

h1 {
  text-align: center;
  font-size: 1.4rem;
}

.controls {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-bottom: 12px;
}

input[type=file], button {
  padding: 14px;
  font-size: 1.1rem;
}

#playBtn {
  background: #16a34a;
  color: white;
  font-weight: bold;
}

#stopBtn {
  background: #fecaca;
  color: #111;
}

#score {
  background: white;
  padding: 10px;
  border-radius: 6px;
  margin-top: 10px;
}

#currentNote {
  text-align: center;
  font-size: 3rem;
  font-weight: bold;
  margin-top: 12px;
}
</style>
</head>

<body>

<h1>üéº VoxSolfejo<br><small>Solfejo Musical com S√≠ntese de Voz</small></h1>

<div class="controls">
  <input type="file" id="fileInput" accept=".xml,.musicxml,.mxl">
  <button id="playBtn" disabled>‚ñ∂ Reproduzir Solfejo</button>
  <button id="stopBtn" disabled>‚èπ Parar</button>
</div>

<div id="currentNote">‚Äî</div>
<div id="score"></div>

<script>
/* =====================
   CONFIGURA√á√ÉO
===================== */

const SOLFEJO = [
  { nome: "D√≥", vogal: "√≥" },
  { nome: "R√©", vogal: "√©" },
  { nome: "Mi", vogal: "i" },
  { nome: "F√°", vogal: "√°" },
  { nome: "Sol", vogal: "√≥" },
  { nome: "L√°", vogal: "√°" },
  { nome: "Si", vogal: "i" }
];

const SEMI = [0,2,4,5,7,9,11];

let osmd;
let timeline = [];
let bpm = 120;
let playing = false;

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

/* =====================
   UTILIT√ÅRIOS
===================== */

function freq(step, octave, alter = 0) {
  const midi = (octave + 1) * 12 + SEMI[step] + alter;
  return 440 * Math.pow(2, (midi - 69) / 12);
}

function textoFalado(step, durMs) {
  const base = SOLFEJO[step];
  const rep = Math.max(1, Math.round(durMs / 120));
  return base.nome + base.vogal.repeat(rep);
}

/* =====================
   LOAD
===================== */

fileInput.onchange = async e => {
  const xml = await e.target.files[0].text();

  osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("score");
  await osmd.load(xml);
  osmd.render();

  extractTempo(xml);
  buildTimeline();

  playBtn.disabled = false;
};

function extractTempo(xml) {
  const dom = new DOMParser().parseFromString(xml, "application/xml");
  const sound = dom.querySelector("sound[tempo]");
  bpm = sound ? parseFloat(sound.getAttribute("tempo")) : 120;
}

/* =====================
   TIMELINE
===================== */

function buildTimeline() {
  timeline = [];

  const voice =
    osmd.Sheet.Instruments[0]
      .Staves[0]
      .Voices[0];

  voice.VoiceEntries.forEach(entry => {
    const dur = entry.Length.RealValue;

    if (!entry.Notes.length) {
      timeline.push({ rest: true, dur });
    } else {
      const p = entry.Notes[0].Pitch;
      timeline.push({
        rest: false,
        step: p.FundamentalNote,
        octave: p.Octave,
        alter: p.Alter || 0,
        dur
      });
    }
  });
}

/* =====================
   PLAYBACK
===================== */

playBtn.onclick = async () => {
  if (playing) return;
  playing = true;
  stopBtn.disabled = false;
  audioCtx.resume();

  for (const ev of timeline) {
    if (!playing) break;

    const durMs = (60000 / bpm) * ev.dur;

    if (!ev.rest) {
      const f = freq(ev.step, ev.octave, ev.alter);
      const texto = textoFalado(ev.step, durMs);

      currentNote.textContent = SOLFEJO[ev.step].nome;

      // SOM
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      gain.gain.value = 0.15;

      osc.frequency.value = f;
      osc.connect(gain).connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + durMs / 1000);

      // VOZ (MESMO REL√ìGIO)
      const u = new SpeechSynthesisUtterance(texto);
      u.lang = "pt-BR";
      u.rate = 1;
      u.volume = 1;
      speechSynthesis.cancel();
      speechSynthesis.speak(u);

      setTimeout(() => speechSynthesis.cancel(), durMs);
    } else {
      currentNote.textContent = "‚Äî";
    }

    await new Promise(r => setTimeout(r, durMs));
  }

  stopPlayback();
};

stopBtn.onclick = stopPlayback;

function stopPlayback() {
  playing = false;
  speechSynthesis.cancel();
  stopBtn.disabled = true;
}
</script>
</body>
</html>
