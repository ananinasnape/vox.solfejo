<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Vox Solfejo</title>

<script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.8.9/build/opensheetmusicdisplay.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #0f172a;
  color: #e5e7eb;
  padding: 20px;
}

h1 { margin-bottom: 10px; }

.controls {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 15px;
}

label {
  font-size: 14px;
}

input[type="number"] {
  width: 80px;
}

button {
  padding: 8px 16px;
  font-size: 15px;
}

button:disabled {
  opacity: 0.4;
}

#status {
  margin-top: 10px;
}

#score {
  margin-top: 20px;
  background: white;
  border-radius: 6px;
}
</style>
</head>

<body>

<h1>ðŸŽ¶ Vox Solfejo</h1>

<div class="controls">
  <input type="file" id="fileInput" accept=".xml,.musicxml,.mxl">

  <label>
    BPM:
    <input type="number" id="bpmInput" value="80" min="30" max="240">
  </label>

  <label>
    A4 (Hz):
    <input type="number" id="hzInput" value="440" min="430" max="450">
  </label>

  <button id="playBtn" disabled>â–¶ Play</button>
</div>

<div id="status">Carregue um MusicXML.</div>

<div id="score"></div>

<script>
const fileInput = document.getElementById("fileInput");
const playBtn   = document.getElementById("playBtn");
const statusEl  = document.getElementById("status");
const bpmInput  = document.getElementById("bpmInput");
const hzInput   = document.getElementById("hzInput");

let osmd;
let events = [];
let divisions = 4;

const solfejo = {
  C: "Do", D: "Re", E: "Mi",
  F: "Fa", G: "Sol", A: "La", B: "Si"
};

fileInput.addEventListener("change", handleFile);
playBtn.addEventListener("click", playSequence);

function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => loadScore(reader.result);
  reader.readAsText(file);
}

async function loadScore(xmlText) {
  playBtn.disabled = true;
  statusEl.textContent = "Carregandoâ€¦";

  // RenderizaÃ§Ã£o da partitura
  if (!osmd) {
    osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("score", {
      drawTitle: true
    });
  }

  await osmd.load(xmlText);
  osmd.render();

  parseXML(xmlText);

  if (events.length > 0) {
    statusEl.textContent = "Pronto para tocar.";
    playBtn.disabled = false;
  } else {
    statusEl.textContent = "Nenhuma nota vÃ¡lida.";
  }
}

function parseXML(text) {
  events = [];

  const xml = new DOMParser().parseFromString(text, "application/xml");

  const divNode = xml.querySelector("divisions");
  if (divNode) divisions = parseInt(divNode.textContent, 10);

  const notes = xml.querySelectorAll("note");

  notes.forEach(note => {
    const durNode = note.querySelector("duration");
    if (!durNode) return;

    const duration = parseInt(durNode.textContent, 10);

    if (note.querySelector("rest")) {
      events.push({ type: "rest", duration });
      return;
    }

    const pitch = note.querySelector("pitch");
    if (!pitch) return;

    const step = pitch.querySelector("step")?.textContent;
    if (!step) return;

    events.push({
      type: "note",
      name: solfejo[step],
      duration
    });
  });
}

function playSequence() {
  playBtn.disabled = true;
  statusEl.textContent = "Tocandoâ€¦";

  const bpm = parseInt(bpmInput.value, 10);
  const a4hz = parseInt(hzInput.value, 10); // jÃ¡ preparado

  let i = 0;

  function next() {
    if (i >= events.length) {
      statusEl.textContent = "Fim.";
      playBtn.disabled = false;
      return;
    }

    const ev = events[i++];
    const seconds = (60 / bpm) * (ev.duration / divisions);

    if (ev.type === "note") {
      const u = new SpeechSynthesisUtterance(ev.name);
      u.lang = "pt-BR";
      speechSynthesis.speak(u);
    }

    setTimeout(next, seconds * 1000);
  }

  next();
}
</script>

</body>
</html>
