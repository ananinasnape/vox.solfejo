<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VoxSolfejo</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/opensheetmusicdisplay@1.8.5/build/opensheetmusicdisplay.min.js"></script>

<style>
body { background:#0f172a; color:white; }
button:disabled { opacity:.4; cursor:not-allowed; }
</style>
</head>

<body class="p-4 max-w-4xl mx-auto space-y-4">

<h1 class="text-2xl font-black text-center">ðŸŽ¶ VoxSolfejo</h1>

<input type="file" id="fileInput" accept=".xml,.musicxml,.mxl"
  class="block w-full text-sm mb-2">

<div class="flex gap-3">
  <button id="testSound" class="bg-green-600 px-4 py-2 rounded font-bold">
    ðŸ”Š TESTAR SOM
  </button>

  <button id="playBtn" disabled
    class="bg-indigo-600 px-4 py-2 rounded font-bold">
    â–¶ PLAY
  </button>
</div>

<label class="text-sm">
  BPM
  <input type="range" id="bpm" min="40" max="200" value="80">
  <span id="bpmVal">80</span>
</label>

<div id="score" class="bg-white text-black rounded-xl p-3"></div>

<script>
let audioCtx = null;
let queue = [];

const SOLFEJO = ['DÃ³','RÃ©','Mi','FÃ¡','Sol','LÃ¡','Si'];
const REF = [-9,-7,-5,-4,-2,0,2];

const osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("score", {
  autoResize: true,
  drawTitle: false
});

/* ===== TEST SOUND ===== */
document.getElementById("testSound").onclick = async () => {
  if (!audioCtx) audioCtx = new AudioContext();
  await audioCtx.resume();
  const o = audioCtx.createOscillator();
  o.frequency.value = 440;
  o.connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime + .3);
};

/* ===== LOAD FILE ===== */
document.getElementById("fileInput").onchange = async e => {
  const file = e.target.files[0];
  if (!file) return;

  await osmd.load(await file.arrayBuffer());
  osmd.render();

  extrairNotasCorretamente();

  console.log("Notas extraÃ­das:", queue.length);

  document.getElementById("playBtn").disabled = queue.length === 0;
};

/* ===== EXTRAÃ‡ÃƒO CORRETA (API REAL) ===== */
function extrairNotasCorretamente() {
  queue = [];

  osmd.GraphicSheet.MeasureList.forEach(medidas => {
    medidas.forEach(m => {
      m.staffEntries.forEach(se => {
        se.graphicalVoiceEntries.forEach(gve => {
          gve.notes.forEach(gn => {
            const p = gn.sourceNote?.Pitch;
            if (!p) return;

            queue.push({
              letra: p.FundamentalNote,
              oitava: p.Octave,
              acidente: p.Accidental || 0,
              dur: gn.sourceNote.Length.RealValue
            });
          });
        });
      });
    });
  });
}

/* ===== PLAY ===== */
document.getElementById("playBtn").onclick = async () => {
  if (!audioCtx) audioCtx = new AudioContext();
  await audioCtx.resume();

  const bpm = +document.getElementById("bpm").value;

  for (const n of queue) {
    const t = n.dur * (60 / bpm) * 4;

    const o = audioCtx.createOscillator();
    o.type = "triangle";
    o.frequency.value =
      440 * Math.pow(2, (REF[n.letra] + (n.oitava - 4) * 12 + n.acidente) / 12);

    o.connect(audioCtx.destination);
    o.start();
    o.stop(audioCtx.currentTime + t);

    speechSynthesis.speak(
      new SpeechSynthesisUtterance(SOLFEJO[n.letra])
    );

    await new Promise(r => setTimeout(r, t * 1000));
  }
};

document.getElementById("bpm").oninput =
  e => bpmVal.innerText = e.target.value;
</script>

</body>
</html>
