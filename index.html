<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>üéº VoxSolfejo</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #111;
  color: #eee;
  padding: 20px;
}

h1 {
  text-align: center;
  font-size: 26px;
}

#controls {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  justify-content: center;
  margin: 20px 0;
}

button {
  padding: 12px 18px;
  font-size: 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

#playBtn {
  background: #1db954;
  color: #000;
  font-weight: bold;
}

#stopBtn {
  background: #ff6666;
  color: #000;
  font-weight: bold;
}

input[type="file"] {
  background: #333;
  color: #fff;
  padding: 10px;
  border-radius: 6px;
}

label {
  font-size: 14px;
}

#log {
  margin-top: 20px;
  background: #000;
  padding: 12px;
  height: 260px;
  overflow-y: auto;
  font-family: monospace;
  font-size: 14px;
}

.note-current {
  font-size: 20px;
  color: #1db954;
  font-weight: bold;
}
</style>
</head>

<body>

<h1>üéº VoxSolfejo<br>
Solfejo Musical com S√≠ntese de Voz e Tom Musical</h1>

<div id="controls">
  <input type="file" id="fileInput" accept=".xml,.musicxml">

  <button id="playBtn">‚ñ∂ Reproduzir Solfejo</button>
  <button id="stopBtn">‚èπ PARAR</button>

  <label>BPM:
    <input type="number" id="bpmInput" value="80" min="30" max="240">
  </label>

  <label>A4 (Hz):
    <input type="number" id="tuningInput" value="440" min="430" max="450">
  </label>
</div>

<div id="log"></div>

<script>
let audioCtx;
let isPlaying = false;
let scheduled = [];
let notes = [];
let divisions = 4;

const solfejoMap = {
  C: "D√≥",
  D: "R√©",
  E: "Mi",
  F: "F√°",
  G: "Sol",
  A: "L√°",
  B: "Si"
};

function log(msg, highlight=false) {
  const div = document.createElement("div");
  div.textContent = msg;
  if (highlight) div.className = "note-current";
  document.getElementById("log").appendChild(div);
  document.getElementById("log").scrollTop = 999999;
}

function stepToFreq(step, octave, tuning) {
  const semis = {C:0,D:2,E:4,F:5,G:7,A:9,B:11};
  const midi = (octave + 1) * 12 + semis[step];
  return tuning * Math.pow(2, (midi - 69) / 12);
}

function parseXML(text) {
  notes = [];
  const xml = new DOMParser().parseFromString(text, "application/xml");

  const divNode = xml.querySelector("divisions");
  if (divNode) divisions = parseInt(divNode.textContent);

  xml.querySelectorAll("note").forEach(n => {
    const rest = n.querySelector("rest");
    const duration = parseInt(n.querySelector("duration")?.textContent || 0);

    if (rest) {
      notes.push({rest:true, duration});
    } else {
      const step = n.querySelector("step")?.textContent;
      const octave = parseInt(n.querySelector("octave")?.textContent);
      if (step && !isNaN(octave)) {
        notes.push({step, octave, duration});
      }
    }
  });

  log("‚úî MusicXML carregado. Notas: " + notes.length);
}

function play() {
  if (!notes.length) {
    alert("Carregue um MusicXML primeiro.");
    return;
  }

  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  isPlaying = true;
  scheduled = [];
  document.getElementById("log").innerHTML = "";

  const bpm = parseInt(document.getElementById("bpmInput").value);
  const tuning = parseFloat(document.getElementById("tuningInput").value);
  const beatMs = 60000 / bpm;
  let t = audioCtx.currentTime;

  notes.forEach(n => {
    const durSec = (n.duration / divisions) * (60 / bpm);

    if (n.rest) {
      t += durSec;
      return;
    }

    const freq = stepToFreq(n.step, n.octave, tuning);

    // MIDI de fundo
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    gain.gain.value = 0.08;

    osc.frequency.value = freq;
    osc.type = "sine";
    osc.connect(gain).connect(audioCtx.destination);
    osc.start(t);
    osc.stop(t + durSec);

    // Voz sincronizada
    const u = new SpeechSynthesisUtterance(solfejoMap[n.step]);
    u.rate = 1;
    u.pitch = 1;
    u.volume = 1;

    setTimeout(() => {
      if (!isPlaying) return;
      log(`‚ñ∂ ${solfejoMap[n.step]} ${n.step}${n.octave} ${freq.toFixed(2)} Hz`, true);
      speechSynthesis.speak(u);
    }, (t - audioCtx.currentTime) * 1000);

    t += durSec;
  });
}

function stop() {
  isPlaying = false;
  speechSynthesis.cancel();
  if (audioCtx) audioCtx.close();
  log("‚èπ Parado.");
}

document.getElementById("fileInput").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => parseXML(reader.result);
  reader.readAsText(file);
});

document.getElementById("playBtn").onclick = play;
document.getElementById("stopBtn").onclick = stop;
</script>

</body>
</html>
