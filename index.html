<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>üéº VoxSolfejo ‚Äì Solfejo Musical com Voz, MIDI e Partitura</title>

<script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.8.9/build/opensheetmusicdisplay.min.js"></script>

<style>
body {
  font-family: "Segoe UI", Arial, sans-serif;
  background: #0f172a;
  color: #f1f5f9;
  padding: 20px;
}

h2 {
  color: #38bdf8;
  margin-bottom: 10px;
}

.controls {
  display: flex;
  gap: 14px;
  align-items: center;
  flex-wrap: wrap;
  margin-bottom: 12px;
}

#score {
  background: white;
  margin-top: 10px;
  border-radius: 6px;
  padding: 10px;
}

#log {
  background: #1e293b;
  margin-top: 1em;
  padding: 12px;
  border-radius: 6px;
  font-family: monospace;
  font-size: 14px;
  max-height: 240px;
  overflow-y: auto;
}

.log-active {
  color: #38bdf8;
  font-size: 15px;
  font-weight: bold;
}

button {
  padding: 12px 20px;
  font-size: 15px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: transform 0.1s ease;
}

button:hover {
  transform: scale(1.05);
}

#playBtn {
  background: #16a34a;
  color: white;
  font-weight: bold;
}

#stopBtn {
  background: #f87171;
  color: black;
  font-weight: bold;
}

#fileInput {
  background: #334155;
  padding: 8px;
  border-radius: 6px;
  font-size: 14px;
  color: white;
}

#status {
  margin-top: 8px;
  font-weight: bold;
  color: #facc15;
}
</style>
</head>

<body>
<h2>üéº VoxSolfejo<br>Solfejo Musical com Voz, MIDI e Partitura</h2>

<div class="controls">
  <input type="file" id="fileInput" accept=".xml,.musicxml,.mxl">
  <label>BPM: <input type="number" id="bpmInput" value="80"></label>
  <label>A4: <input type="number" id="hzInput" value="440"></label>
  <button id="playBtn" disabled>‚ñ∂ Reproduzir</button>
  <button id="stopBtn" disabled>‚èπ Parar</button>
</div>

<div id="status">Status: aguardando arquivo...</div>
<div id="score"></div>
<div id="log"></div>

<script>
const SOLFEJO = {
  C:{nome:"D√≥",vogal:"√≥"},
  D:{nome:"R√©",vogal:"√©"},
  E:{nome:"Mi",vogal:"i"},
  F:{nome:"F√°",vogal:"√°"},
  G:{nome:"Sol",vogal:"√≥"},
  A:{nome:"L√°",vogal:"√°"},
  B:{nome:"Si",vogal:"i"}
};

const SEMI = {C:-9,D:-7,E:-5,F:-4,G:-2,A:0,B:2};

let osmd, events=[], divisions=4, idx=0;
let ctx=new (window.AudioContext||window.webkitAudioContext)();
let playing=false, timer=null;
let lastActiveLine=null;
let cursor=null;

fileInput.onchange=e=>{
  const r=new FileReader();
  r.onload=()=>loadScore(r.result);
  r.readAsText(e.target.files[0]);
};

playBtn.onclick=play;
stopBtn.onclick=stop;

async function loadScore(xml){
  osmd ||= new opensheetmusicdisplay.OpenSheetMusicDisplay("score"); // mant√©m t√≠tulo e textos
  await osmd.load(xml);
  osmd.render();
  cursor = osmd.cursor;
  cursor.show();
  parseXML(xml);
  playBtn.disabled = stopBtn.disabled = false;
  document.getElementById("status").textContent = "Status: pronto para reproduzir üé∂";
}

function parseXML(txt){
  events=[]; idx=0; log.innerHTML="";
  const xml=new DOMParser().parseFromString(txt,"application/xml");
  divisions=parseInt(xml.querySelector("divisions")?.textContent||4);

  xml.querySelectorAll("note").forEach(n=>{
    const dur=parseInt(n.querySelector("duration")?.textContent||0);
    const tieStart = n.querySelector('tie[type="start"]');
    const tieStop  = n.querySelector('tie[type="stop"]');

    if(n.querySelector("rest")){
      events.push({rest:true,dur});
      return;
    }

    events.push({
      step:n.querySelector("step").textContent,
      oct:parseInt(n.querySelector("octave").textContent),
      alter:parseInt(n.querySelector("alter")?.textContent||0),
      dur,
      tieStart:!!tieStart,
      tieStop:!!tieStop
    });
  });
}

function freq(step,oct,alter){
  const a4=+hzInput.value;
  const s=SEMI[step]+alter+(oct-4)*12;
  return a4*Math.pow(2,s/12);
}

function solfejoFalado(step,durMs){
  const base=SOLFEJO[step];
  const reps=Math.max(1,Math.round(durMs/200));
  return base.nome + ("-"+base.vogal).repeat(reps);
}

function play(){
  if(playing) return;
  playing=true;
  ctx.resume();
  idx=0;
  cursor.reset();
  document.getElementById("status").textContent = "Status: reproduzindo üéµ";
  next();
}

function stop(){
  playing=false;
  clearTimeout(timer);
  speechSynthesis.cancel();
  idx=0;
  if(cursor) cursor.reset();
  document.getElementById("status").textContent = "Status: parado ‚èπ";
}

function addLogLine(text){
  if(lastActiveLine){
    lastActiveLine.classList.remove("log-active");
  }
  const div=document.createElement("div");
  div.textContent=text;
  div.classList.add("log-active");
  log.appendChild(div);
  lastActiveLine=div;
  log.scrollTop=log.scrollHeight;
}

function next(){
  if(!playing||idx>=events.length){
    playing=false;
    log.innerHTML += `<div>=== REPRODU√á√ÉO FINALIZADA ===</div>`;
    if(cursor) cursor.reset();
    document.getElementById("status").textContent = "Status: finalizado ‚úÖ";
    return;
  }

  const bpm=+bpmInput.value;
  let e=events[idx++];
  let totalDur=e.dur;

  if(e.tieStart){
    while(idx<events.length && !events[idx-1].tieStop){
      totalDur+=events[idx].dur;
      idx++;
    }
  }

  const ms=(60/bpm)*(totalDur/divisions)*1000;

  if(!e.rest){
    const f=freq(e.step,e.oct,e.alter);

    // Oscilador sincronizado
    const osc=ctx.createOscillator();
    const g=ctx.createGain();
    g.gain.value=0.08;
    osc.frequency.value=f;
    osc.connect(g).connect(ctx.destination);
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime+ms/1000);

    // Cursor e log avan√ßam junto com som
    const texto=solfejoFalado(e.step,ms);
    addLogLine(`üé∂ ${texto} - ${Math.round(ms)} ms`);
    if(cursor) cursor.next();

    // Voz disparada no mesmo instante
    const u=new SpeechSynthesisUtterance(texto);
    u.rate=1;
    speechSynthesis.speak(u);
  } else {
    addLogLine(`(pausa) - ${Math.round(ms)} ms`);
    if(cursor) cursor.next();
  }

  timer=setTimeout(next,ms);
}
</script>
</body>
</html>
