<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VoxSolfejo Maestro</title>

<script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.9.0/build/opensheetmusicdisplay.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body { background:#0f172a; color:white; }
button:disabled { opacity:.4; }
</style>
</head>

<body class="p-4">

<div class="max-w-5xl mx-auto bg-slate-800 rounded-2xl p-4 space-y-4">

<header class="flex justify-between items-center">
  <h1 class="text-xl font-bold">ðŸŽ¼ VoxSolfejo Maestro</h1>

  <label class="bg-indigo-600 px-4 py-2 rounded cursor-pointer">
    Upload MusicXML
    <input type="file" id="fileInput" class="hidden" accept=".xml,.musicxml,.mxl">
  </label>
</header>

<div id="osmdCanvas" class="bg-white rounded-xl p-2 min-h-[300px] text-black">
  <p class="text-center text-gray-400 mt-24">Carregue uma partitura MusicXML</p>
</div>

<div class="flex gap-4 items-center">
  <button id="playBtn" disabled
    class="flex-1 bg-green-600 py-3 rounded-xl font-bold text-lg">
    â–¶ PLAY
  </button>

  <button id="stopBtn"
    class="bg-red-600 px-6 py-3 rounded-xl font-bold">
    â– 
  </button>
</div>

<div class="flex gap-4 text-sm">
  <div>
    BPM:
    <input id="bpm" type="number" value="80" class="text-black w-16 ml-1">
  </div>
  <div>
    AfinaÃ§Ã£o:
    <input id="hz" type="number" value="440" class="text-black w-20 ml-1">
  </div>
</div>

</div>

<script>
let osmd;
let queue = [];
let audioCtx;
let playing = false;

const NOTE_INDEX = { C:-9, D:-7, E:-5, F:-4, G:-2, A:0, B:2 };

function freqFromNote(letter, octave, hz) {
  const semitones = NOTE_INDEX[letter] + (octave - 4) * 12;
  return hz * Math.pow(2, semitones / 12);
}

document.getElementById("fileInput").onchange = async e => {
  const file = e.target.files[0];
  if (!file) return;

  if (!osmd) {
    osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("osmdCanvas");
  }

  await osmd.load(URL.createObjectURL(file));
  osmd.render();

  queue = [];

  const measures =
    osmd.GraphicSheet.MusicPages[0]
      .MusicSystems[0]
      .StaffLines[0]
      .Measures;

  measures.forEach(m =>
    m.StaffEntries.forEach(se => {
      const model = se.ModelStaffEntry;
      const dur = model.Duration.RealValue;

      if (model.Notes.length > 0) {
        const n = model.Notes[0].Pitch;
        queue.push({
          letter: "CDEFGAB"[n.FundamentalNote],
          octave: n.Octave + 3,
          dur
        });
      } else {
        queue.push({ rest:true, dur });
      }
    })
  );

  document.getElementById("playBtn").disabled = false;
};

async function play() {
  if (playing || queue.length === 0) return;
  playing = true;

  if (!audioCtx) audioCtx = new AudioContext();
  await audioCtx.resume();

  const bpm = +document.getElementById("bpm").value;
  const hz = +document.getElementById("hz").value;

  for (const n of queue) {
    if (!playing) break;

    const durSec = n.dur * (60 / bpm) * 4;

    if (!n.rest) {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      osc.frequency.value = freqFromNote(n.letter, n.octave, hz);
      gain.gain.value = 0.25;

      osc.connect(gain);
      gain.connect(audioCtx.destination);

      osc.start();
      osc.stop(audioCtx.currentTime + durSec);
    }

    await new Promise(r => setTimeout(r, durSec * 1000));
  }

  playing = false;
}

document.getElementById("playBtn").onclick = play;
document.getElementById("stopBtn").onclick = () => playing = false;
</script>

</body>
</html>
