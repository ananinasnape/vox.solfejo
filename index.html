<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoxSolfejo Maestro AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0F172A; color: #F1F5F9; font-family: sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.95); border: 1px solid rgba(255,255,255,0.1); }
        #canvas-container { background: white; border-radius: 1rem; min-height: 500px; display: flex; align-items: center; justify-content: center; }
        canvas { max-width: 100%; border-radius: 1rem; }
        .note-btn { background: #1E293B; border: 1px solid #334155; transition: 0.1s; }
        .note-btn:active { background: #4F46E5; transform: scale(0.95); }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto space-y-6">
        <!-- HEADER -->
        <header class="glass rounded-3xl p-6 flex justify-between items-center shadow-2xl">
            <div>
                <h1 class="text-2xl font-black text-indigo-400 italic uppercase">VoxSolfejo Maestro</h1>
                <p class="text-[10px] font-bold opacity-60">SISTEMA INTEGRADO 440Hz â€¢ 2026</p>
            </div>
            <label class="bg-indigo-600 text-white px-6 py-2 rounded-full font-bold cursor-pointer text-xs">
                ðŸ“‚ ABRIR PDF
                <input type="file" id="fileInput" class="hidden" accept=".pdf">
            </label>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- PARTITURA -->
            <div class="lg:col-span-8">
                <div id="canvas-container" class="shadow-2xl">
                    <canvas id="pdfCanvas"></canvas>
                    <p id="msg" class="text-slate-400 italic">Carregue um PDF para visualizar a partitura.</p>
                </div>
            </div>

            <!-- CONTROLES -->
            <div class="lg:col-span-4 space-y-4">
                <!-- MONITOR -->
                <div class="glass rounded-3xl p-6 text-center border-t-4 border-indigo-500">
                    <div id="vocalLabel" class="text-7xl font-black text-white">--</div>
                    <div id="hzLabel" class="text-indigo-400 font-mono text-xs mt-2 italic tracking-widest text-xs">A4 = 440.00 Hz</div>
                </div>

                <!-- EDITOR E ACIDENTES -->
                <div class="glass rounded-3xl p-5 space-y-3">
                    <div class="flex gap-1">
                        <button onclick="insert('â™¯')" class="flex-1 bg-slate-800 py-2 rounded font-bold text-indigo-400 border border-slate-700">â™¯</button>
                        <button onclick="insert('â™­')" class="flex-1 bg-slate-800 py-2 rounded font-bold text-indigo-400 border border-slate-700">â™­</button>
                        <button onclick="insert('â™®')" class="flex-1 bg-slate-800 py-2 rounded font-bold text-indigo-400 border border-slate-700">â™®</button>
                    </div>
                    <textarea id="textoInput" class="w-full h-24 p-3 rounded-xl bg-slate-900 border border-slate-700 text-indigo-300 outline-none" placeholder="C D E...">C D E F G A B</textarea>
                    <button onclick="processarTexto()" class="w-full py-2 bg-indigo-500/20 text-indigo-300 rounded-lg text-[10px] font-bold uppercase tracking-widest">Processar Notas</button>
                </div>

                <!-- SLIDERS -->
                <div class="glass rounded-3xl p-5 space-y-4">
                    <div class="flex justify-between text-[10px] font-bold"><span>BPM: <span id="bpmText">80</span></span></div>
                    <input type="range" id="bpmRange" min="20" max="220" value="80" class="w-full h-1.5 accent-indigo-500 appearance-none bg-slate-700 rounded-lg">
                    
                    <div class="flex justify-between text-[10px] font-bold"><span>CALIBRAÃ‡ÃƒO: <span id="calibText">440Hz</span></span></div>
                    <input type="range" id="calibRange" min="415" max="466" value="440" class="w-full h-1.5 accent-indigo-500 appearance-none bg-slate-700 rounded-lg">
                </div>

                <button onclick="iniciarSolfejo()" class="w-full py-6 bg-indigo-600 text-white rounded-[2rem] font-black text-3xl shadow-xl hover:bg-indigo-500 transition-all italic">PLAY</button>
                <button onclick="parar()" class="w-full py-2 text-slate-500 font-bold uppercase text-[9px] tracking-widest">Parar</button>
            </div>
        </div>
    </div>

    <!-- Script de PDF embutido para evitar bloqueios do GitHub -->
    <script src="https://cdnjs.cloudflare.com"></script>

    <script>
        const FREQS = { 'C': -9, 'D': -7, 'E': -5, 'F': -4, 'G': -2, 'A': 0, 'B': 2 };
        const SYLL = { 'C': 'DÃ³', 'D': 'RÃ©', 'E': 'Mi', 'F': 'FÃ¡', 'G': 'Sol', 'A': 'LÃ¡', 'B': 'Si' };
        let audioCtx, queue = [], rodando = false;

        function insert(s) {
            const el = document.getElementById('textoInput');
            el.setRangeText(s, el.selectionStart, el.selectionEnd, 'end');
            el.focus();
        }

        // CARREGAR PDF (VersÃ£o Blindada)
        document.getElementById('fileInput').onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('msg').style.display = 'none';
            const reader = new FileReader();
            reader.onload = function() {
                const typedarray = new Uint8Array(this.result);
                const pdfjsLib = window['pdfjs-dist/build/pdf'];
                pdfjsLib.getDocument(typedarray).promise.then(pdf => {
                    pdf.getPage(1).then(page => {
                        const canvas = document.getElementById('pdfCanvas');
                        const context = canvas.getContext('2d');
                        const viewport = page.getViewport({scale: 1.5});
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        page.render({canvasContext: context, viewport: viewport});
                    });
                });
            };
            reader.readAsArrayBuffer(file);
        };

        function processarTexto() {
            const raw = document.getElementById('textoInput').value.toUpperCase().match(/([A-G])([â™¯â™­â™®]?)/g);
            if (raw) {
                queue = raw.map(n => ({
                    letra: n[0],
                    mod: n.includes('â™¯') ? 1 : n.includes('â™­') ? -1 : 0
                }));
                alert("Notas carregadas!");
            }
        }

        function cantar(item, tempo) {
            if (!audioCtx) audioCtx = new AudioContext();
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const base = parseInt(document.getElementById('calibRange').value);
            const freq = base * Math.pow(2, (FREQS[item.letra] + item.mod) / 12);

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);

            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + tempo);

            const talk = new SpeechSynthesisUtterance(SYLL[item.letra]);
            talk.lang = 'pt-BR';
            window.speechSynthesis.speak(talk);

            document.getElementById('vocalLabel').innerText = SYLL[item.letra] + (item.mod === 1 ? 'â™¯' : item.mod === -1 ? 'â™­' : '');
            document.getElementById('hzLabel').innerText = freq.toFixed(2) + " Hz";

            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + tempo);
        }

        async function iniciarSolfejo() {
            if (rodando || queue.length === 0) {
                if(queue.length === 0) processarTexto();
            }
            rodando = true;
            const bpm = document.getElementById('bpmRange').value;
            const t = 60 / bpm;

            for (let n of queue) {
                if (!rodando) break;
                cantar(n, t);
                await new Promise(r => setTimeout(r, t * 1000));
            }
            rodando = false;
        }

        function parar() {
            rodando = false;
            window.speechSynthesis.cancel();
        }

        // ATUALIZAÃ‡ÃƒO DOS SLIDERS
        document.getElementById('bpmRange').oninput = (e) => document.getElementById('bpmText').innerText = e.target.value;
        document.getElementById('calibRange').oninput = (e) => document.getElementById('calibText').innerText = e.target.value + "Hz";
    </script>
</body>
</html>
