<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>üéº VoxSolfejo</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #111;
  color: #eee;
  padding: 20px;
}

h1 {
  text-align: center;
  font-size: 26px;
}

#controls {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  justify-content: center;
  margin: 20px 0;
}

button {
  padding: 12px 18px;
  font-size: 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

#playBtn {
  background: #1db954;
  color: #000;
  font-weight: bold;
}

#stopBtn {
  background: #ff7777;
  color: #000;
  font-weight: bold;
}

input[type="file"] {
  background: #333;
  color: #fff;
  padding: 10px;
  border-radius: 6px;
}

label {
  font-size: 14px;
}

#log {
  margin-top: 20px;
  background: #000;
  padding: 12px;
  height: 200px;
  overflow-y: auto;
  font-family: monospace;
}

.note-current {
  font-size: 20px;
  color: #1db954;
  font-weight: bold;
}

.debug-panel {
  margin-top: 20px;
  background: #060606;
  border: 1px solid #333;
  padding: 12px;
  font-family: monospace;
  font-size: 13px;
  color: #aaa;
  max-height: 220px;
  overflow-y: auto;
}
</style>
</head>

<body>

<h1>üéº VoxSolfejo<br>
Solfejo Musical com S√≠ntese de Voz e Tom Musical</h1>

<div id="controls">
  <input type="file" id="fileInput" accept=".xml,.musicxml">

  <button id="playBtn">‚ñ∂ Reproduzir Solfejo</button>
  <button id="stopBtn">‚èπ PARAR</button>

  <label>BPM:
    <input type="number" id="bpmInput" value="80" min="30" max="240">
  </label>

  <label>A4 (Hz):
    <input type="number" id="tuningInput" value="440" min="430" max="450">
  </label>
</div>

<div id="log"></div>

<div class="debug-panel" id="debugPanel"></div>

<script>
let audioCtx;
let isPlaying = false;
let notes = [];
let divisions = 4;

const solfejoMap = { C:"D√≥", D:"R√©", E:"Mi", F:"F√°", G:"Sol", A:"L√°", B:"Si" };

function log(msg, highlight=false) {
  const d = document.createElement("div");
  d.textContent = msg;
  if (highlight) d.className = "note-current";
  logBox.appendChild(d);
  logBox.scrollTop = logBox.scrollHeight;
}

const logBox = document.getElementById("log");
const debugPanel = document.getElementById("debugPanel");

function stepToFreq(step, octave, tuning) {
  const semis = {C:0,D:2,E:4,F:5,G:7,A:9,B:11};
  const midi = (octave + 1) * 12 + semis[step];
  return tuning * Math.pow(2, (midi - 69) / 12);
}

function parseXML(text) {
  notes = [];
  const xml = new DOMParser().parseFromString(text, "application/xml");

  const divNode = xml.querySelector("divisions");
  if (divNode) divisions = parseInt(divNode.textContent);

  xml.querySelectorAll("note").forEach(n => {
    const duration = parseInt(n.querySelector("duration")?.textContent || 0);
    if (n.querySelector("rest")) {
      notes.push({ rest:true, duration });
    } else {
      const step = n.querySelector("step")?.textContent;
      const octave = parseInt(n.querySelector("octave")?.textContent);
      if (step && !isNaN(octave)) {
        notes.push({ step, octave, duration });
      }
    }
  });

  log("‚úî MusicXML carregado (" + notes.length + " eventos)");
}

function play() {
  if (!notes.length) return alert("Carregue um MusicXML primeiro.");

  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  isPlaying = true;
  logBox.innerHTML = "";
  debugPanel.innerHTML = "";

  const bpm = +bpmInput.value;
  const tuning = +tuningInput.value;
  let t = audioCtx.currentTime;

  notes.forEach(n => {
    const durMs = (n.duration / divisions) * (60000 / bpm);
    const durSec = durMs / 1000;

    if (n.rest) {
      debugPanel.innerHTML += `‚ñ∂ PAUSA - ${durMs.toFixed(0)} ms<br>`;
      t += durSec;
      return;
    }

    const freq = stepToFreq(n.step, n.octave, tuning);
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    gain.gain.value = 0.08;

    osc.frequency.value = freq;
    osc.connect(gain).connect(audioCtx.destination);
    osc.start(t);
    osc.stop(t + durSec);

    setTimeout(() => {
      if (!isPlaying) return;
      log(`‚ñ∂ ${solfejoMap[n.step]}${n.octave}`, true);
      speechSynthesis.speak(new SpeechSynthesisUtterance(solfejoMap[n.step]));
    }, (t - audioCtx.currentTime) * 1000);

    debugPanel.innerHTML += `‚ñ∂ ${solfejoMap[n.step]}${n.octave} - ${freq.toFixed(2)} Hz por ${durMs.toFixed(0)} ms<br>`;
    t += durSec;
  });

  setTimeout(() => {
    debugPanel.innerHTML += "=== REPRODU√á√ÉO FINALIZADA ===<br>";
  }, (t - audioCtx.currentTime) * 1000);
}

function stop() {
  isPlaying = false;
  speechSynthesis.cancel();
  if (audioCtx) audioCtx.close();
  debugPanel.innerHTML += "=== PARADO MANUALMENTE ===<br>";
}

fileInput.onchange = e => {
  const r = new FileReader();
  r.onload = () => parseXML(r.result);
  r.readAsText(e.target.files[0]);
};

playBtn.onclick = play;
stopBtn.onclick = stop;
</script>

</body>
</html>
