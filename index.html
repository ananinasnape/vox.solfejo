<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>üéº VoxSolfejo ‚Äì Solfejo Musical com S√≠ntese de Voz</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.8.9/build/opensheetmusicdisplay.min.js"></script>

<style>
body {
  font-family: Inter, system-ui, sans-serif;
  background: linear-gradient(135deg,#667eea,#764ba2);
  padding: 20px;
}
.container {
  max-width: 1400px;
  margin: auto;
  background: white;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0,0,0,.3);
}
header {
  background: linear-gradient(135deg,#4F46E5,#7C3AED);
  color: white;
  padding: 30px;
  text-align: center;
}
header h1 { font-size: 2.4rem; }
.subtitle { opacity: .9; }
.controls-panel {
  padding: 30px;
  background: #f8fafc;
  border-bottom: 1px solid #e2e8f0;
}
.file-input-wrapper { position: relative; }
input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
.file-input-button {
  padding: 16px; border: 2px dashed #cbd5e1; border-radius: 10px;
  background: white; text-align: center; font-weight: 600; color: #475569;
}
.buttons-row { display: flex; gap: 14px; margin-top: 20px; }
button {
  padding: 14px 26px; font-size: 1rem; font-weight: 700;
  border-radius: 10px; border: none; cursor: pointer;
}
button:disabled { opacity: .5; cursor: not-allowed; }
.btn-play { background: linear-gradient(135deg,#10b981,#059669); color: white; }
.btn-stop { background: linear-gradient(135deg,#ef4444,#dc2626); color: white; }
.settings-grid {
  display: grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr));
  gap: 20px; margin-top: 25px;
}
.setting-item {
  background: white; border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px;
}
.setting-item label { font-size: .85rem; font-weight: 600; color: #475569; }
input[type="range"], input[type="number"] { width: 100%; margin-top: 8px; }
.value-display { margin-top: 6px; font-weight: 700; color: #4F46E5; }
#status {
  margin: 20px 30px; padding: 14px; background: #f1f5f9; border-left: 4px solid #4F46E5;
}
#score { padding: 30px; background: white; }
.debug-panel {
  margin: 20px 30px; padding: 14px; background: #fef3c7;
  border: 1px solid #fbbf24; border-radius: 10px;
  font-family: monospace; font-size: 13px; max-height: 240px; overflow-y: auto;
}
.log-active { color:#4F46E5; font-weight:bold; }
</style>
</head>

<body>
<div class="container">
<header>
  <h1>üéº VoxSolfejo</h1>
  <div class="subtitle">Solfejo Musical com S√≠ntese de Voz e Tom Musical</div>
</header>

<div class="controls-panel">
  <div class="file-input-wrapper">
    <input type="file" id="fileInput" accept=".xml,.musicxml,.mxl">
    <div class="file-input-button">üì§ ESCOLHER ARQUIVO MUSICXML</div>
  </div>

  <div class="buttons-row">
    <button id="playBtn" class="btn-play" disabled>‚ñ∂Ô∏è Reproduzir Solfejo</button>
    <button id="stopBtn" class="btn-stop" disabled>‚èπÔ∏è PARAR</button>
  </div>

  <div class="settings-grid">
    <div class="setting-item">
      <label>BPM</label>
      <input type="number" id="bpmInput" value="80">
      <div class="value-display"><span id="bpmVal">80</span> BPM</div>
    </div>
    <div class="setting-item">
      <label>A4 (Hz)</label>
      <input type="number" id="hzInput" value="440">
      <div class="value-display"><span id="hzVal">440</span> Hz</div>
    </div>
    <div class="setting-item">
      <label>Volume</label>
      <input type="range" id="volInput" min="0" max="100" value="60">
      <div class="value-display"><span id="volVal">60</span>%</div>
    </div>
    <div class="setting-item">
      <label>Progresso</label>
      <progress id="progressBar" value="0" max="100"></progress>
    </div>
  </div>
</div>

<div id="status">‚è≥ Aguardando partitura MusicXML‚Ä¶</div>
<div id="score"></div>
<div class="debug-panel" id="debugPanel"></div>

<script>
const SOLFEJO={C:{n:"D√≥",v:"√≥"},D:{n:"R√©",v:"√©"},E:{n:"Mi",v:"i"},F:{n:"F√°",v:"√°"},G:{n:"Sol",v:"√≥"},A:{n:"L√°",v:"√°"},B:{n:"Si",v:"i"}};
const SEMI={C:-9,D:-7,E:-5,F:-4,G:-2,A:0,B:2};

let osmd,events=[],idx=0,divisions=4;
let ctx=new (window.AudioContext||window.webkitAudioContext)();
let playing=false,timer=null;
let cursor=null;

fileInput.onchange=e=>{
  const r=new FileReader();
  r.onload=()=>loadScore(r.result);
  r.readAsText(e.target.files[0]);
};

bpmInput.oninput=()=>bpmVal.textContent=bpmInput.value;
hzInput.oninput=()=>hzVal.textContent=hzInput.value;
volInput.oninput=()=>volVal.textContent=volInput.value;

playBtn.onclick=play;
stopBtn.onclick=stop;

async function loadScore(xml){
  osmd ||= new opensheetmusicdisplay.OpenSheetMusicDisplay("score",{drawTitle:true});
  await osmd.load(xml);
  osmd.render();
  cursor=osmd.cursor; cursor.show();
  parseXML(xml);
  playBtn.disabled=stopBtn.disabled=false;
  status.textContent="üéº Partitura carregada. Pronta para reprodu√ß√£o.";
  showScoreInfo(xml);
}

function parseXML(txt){
  events=[]; idx=0; debugPanel.innerHTML="";
  const xml=new DOMParser().parseFromString(txt,"application/xml");
  divisions=parseInt(xml.querySelector("divisions")?.textContent||4);

  xml.querySelectorAll("note").forEach(n=>{
    const dur=parseInt(n.querySelector("duration")?.textContent||0);
    if(n.querySelector("rest")){ events.push({r:true,d:dur}); return; }
    events.push({
      s:n.querySelector("step").textContent,
      o:+n.querySelector("octave").textContent,
      a:+(n.querySelector("alter")?.textContent||0),
      d:dur
    });
  });
}

function showScoreInfo(txt){
  const xml=new DOMParser().parseFromString(txt,"application/xml");
  const title=xml.querySelector("work > work-title")?.textContent||"Sem t√≠tulo";
  const bpm=xml.querySelector("sound")?.getAttribute("tempo")||bpmInput.value;
  const compasso=xml.querySelector("time")? xml.querySelector("time").textContent : "N/D";
  const tom=xml.querySelector("key > fifth")? xml.querySelector("key > fifth").textContent : "N/D";
 
