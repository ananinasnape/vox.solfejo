<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>üéº VoxSolfejo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.8.9/build/opensheetmusicdisplay.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f4f5;
  color: #111827;
  padding: 12px;
}

h2 {
  text-align: center;
  margin-bottom: 10px;
}

.controls {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

button, input[type=file] {
  padding: 12px;
  font-size: 1.1rem;
}

#playBtn {
  background: #16a34a;
  color: white;
  font-weight: bold;
}

#stopBtn {
  background: #fca5a5;
  color: #111;
}

#score {
  background: white;
  margin-top: 12px;
  border-radius: 6px;
  padding: 10px;
}

.current-note {
  text-align: center;
  font-size: 3rem;
  font-weight: bold;
  margin-top: 12px;
}
</style>
</head>

<body>

<h2>üéº VoxSolfejo<br>
<small>Solfejo Musical com S√≠ntese de Voz</small></h2>

<div class="controls">
  <input type="file" id="fileInput" accept=".xml,.musicxml,.mxl">
  <button id="playBtn" disabled>‚ñ∂ Reproduzir Solfejo</button>
  <button id="stopBtn" disabled>‚èπ Parar</button>
</div>

<div class="current-note" id="noteDisplay">‚Äî</div>
<div id="score"></div>

<script>
const SOLFEJO = ["D√≥","R√©","Mi","F√°","Sol","L√°","Si"];
let osmd;
let timeline = [];
let bpm = 120;
let playing = false;
let synth;

fileInput.onchange = async e => {
  const xml = await e.target.files[0].text();
  osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("score");
  await osmd.load(xml);
  osmd.render();
  extractTempo(xml);
  buildTimeline();
  playBtn.disabled = false;
};

function extractTempo(xml) {
  const dom = new DOMParser().parseFromString(xml, "application/xml");
  const sound = dom.querySelector("sound[tempo]");
  bpm = sound ? parseFloat(sound.getAttribute("tempo")) : 120;
}

function buildTimeline() {
  timeline = [];
  const voice =
    osmd.Sheet.Instruments[0]
      .Staves[0]
      .Voices[0];

  voice.VoiceEntries.forEach(e => {
    const dur = e.Length.RealValue;
    if (!e.Notes.length) {
      timeline.push({ rest: true, dur });
    } else {
      timeline.push({
        rest: false,
        step: e.Notes[0].Pitch.FundamentalNote,
        dur
      });
    }
  });
}

function solfejoPorTempo(step, durationMs) {
  const nome = SOLFEJO[step];
  const vogal = nome.slice(-1);
  const rep = Math.max(1, Math.round(durationMs / 120));
  return nome + "-" + vogal.repeat(rep);
}

playBtn.onclick = async () => {
  await Tone.start();
  synth = new Tone.Synth({ oscillator: { type: "sine" } }).toDestination();
  playing = true;
  stopBtn.disabled = false;

  for (const ev of timeline) {
    if (!playing) break;

    const durationMs = (60000 / bpm) * ev.dur;

    if (!ev.rest) {
      noteDisplay.textContent = SOLFEJO[ev.step];

      // MIDI √© a refer√™ncia absoluta
      synth.triggerAttackRelease("C4", durationMs / 1000);

      // VOZ sincronizada AO MIDI
      const u = new SpeechSynthesisUtterance(
        solfejoPorTempo(ev.step, durationMs)
      );
      u.lang = "pt-BR";
      u.rate = 1.6;
      u.volume = 1;
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    } else {
      noteDisplay.textContent = "‚Äî";
    }

    await new Promise(r => setTimeout(r, durationMs));
  }

  stopPlayback();
};

stopBtn.onclick = stopPlayback;

function stopPlayback() {
  playing = false;
  speechSynthesis.cancel();
  if (synth) synth.dispose();
  stopBtn.disabled = true;
}
</script>
</body>
</html>
