<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>VoxSolfejo - Vers√£o Final Funcional</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- OSMD -->
  <script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.8.7/build/opensheetmusicdisplay.min.js"></script>

  <!-- Tone.js -->
  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    header {
      background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .subtitle {
      font-size: 1rem;
      opacity: 0.9;
    }

    .controls-panel {
      padding: 30px;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
    }

    .control-group {
      margin-bottom: 20px;
    }

    .control-group label {
      display: block;
      font-weight: 600;
      color: #334155;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .file-input-wrapper {
      position: relative;
      display: inline-block;
      width: 100%;
    }

    input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-input-button {
      display: block;
      padding: 15px 30px;
      background: white;
      border: 2px dashed #cbd5e1;
      border-radius: 8px;
      text-align: center;
      color: #64748b;
      font-weight: 500;
      transition: all 0.3s;
    }

    .file-input-button:hover {
      border-color: #4F46E5;
      color: #4F46E5;
      background: #f8fafc;
    }

    .buttons-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    button {
      padding: 12px 24px;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-play {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }

    .btn-play:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
    }

    .btn-stop {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }

    .btn-stop:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .setting-item {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    .setting-item label {
      font-size: 0.85rem;
      color: #64748b;
    }

    input[type="range"] {
      width: 100%;
      margin-top: 8px;
    }

    input[type="number"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      margin-top: 8px;
    }

    .value-display {
      font-size: 1.1rem;
      font-weight: 700;
      color: #4F46E5;
      margin-top: 5px;
    }

    #status {
      padding: 15px;
      background: #f1f5f9;
      border-left: 4px solid #4F46E5;
      margin: 20px 30px;
      border-radius: 4px;
      font-weight: 500;
      color: #334155;
    }

    #score {
      background: white;
      padding: 30px;
      min-height: 400px;
      overflow-x: auto;
    }

    .current-note {
      background: rgba(79, 70, 229, 0.1);
      padding: 20px;
      margin: 20px 30px;
      border-radius: 8px;
      text-align: center;
    }

    .current-note h3 {
      color: #64748b;
      font-size: 0.9rem;
      margin-bottom: 10px;
    }

    .note-display {
      font-size: 3rem;
      font-weight: 700;
      color: #4F46E5;
      animation: pulse 0.5s ease-in-out;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .timeline-info {
      padding: 15px 30px;
      background: #f8fafc;
      color: #64748b;
      font-size: 0.9rem;
    }

    .debug-panel {
      margin: 20px 30px;
      padding: 15px;
      background: #fef3c7;
      border-radius: 8px;
      font-family: monospace;
      font-size: 0.85rem;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #fbbf24;
    }
  </style>
</head>

<body>

<div class="container">
  <header>
    <h1>üéº VoxSolfejo</h1>
    <p class="subtitle">Solfejo Musical com S√≠ntese de Voz e Tom Musical</p>
  </header>

  <div class="controls-panel">
    <div class="control-group">
      <label>üìÅ Carregar Partitura (MusicXML)</label>
      <div class="file-input-wrapper">
        <input type="file" id="fileInput" accept=".xml,.musicxml,.mxl" />
        <div class="file-input-button">
          üì§ Clique para selecionar arquivo MusicXML
        </div>
      </div>
    </div>

    <div class="buttons-row">
      <button id="playBtn" class="btn-play" disabled>
        ‚ñ∂Ô∏è Reproduzir Solfejo
      </button>
      <button id="stopBtn" class="btn-stop" disabled>
        ‚èπÔ∏è Parar
      </button>
    </div>

    <div class="settings-grid">
      <div class="setting-item">
        <label>üéµ Tempo (BPM)</label>
        <input type="range" id="bpmSlider" min="40" max="200" value="80" />
        <div class="value-display"><span id="bpmValue">80</span> BPM</div>
      </div>

      <div class="setting-item">
        <label>üîä Volume</label>
        <input type="range" id="volumeSlider" min="0" max="100" value="70" />
        <div class="value-display"><span id="volumeValue">70</span>%</div>
      </div>

      <div class="setting-item">
        <label>üéöÔ∏è Afina√ß√£o (Hz)</label>
        <input type="number" id="tuningInput" min="410" max="470" value="440" step="1" />
        <div class="value-display">A4 = <span id="tuningValue">440</span> Hz</div>
      </div>

      <div class="setting-item">
        <label>üé§ Taxa de Fala</label>
        <input type="range" id="rateSlider" min="0.5" max="2" value="1" step="0.1" />
        <div class="value-display"><span id="rateValue">1.0</span>x</div>
      </div>
    </div>
  </div>

  <div id="status">‚è≥ Aguardando partitura. Carregue um arquivo MusicXML para come√ßar.</div>

  <div class="current-note" id="currentNoteDisplay" style="display: none;">
    <h3>Nota Atual:</h3>
    <div class="note-display" id="noteText">‚Äî</div>
    <div style="font-size: 0.9rem; color: #64748b; margin-top: 10px;" id="noteDetails"></div>
  </div>

  <div class="timeline-info" id="timelineInfo" style="display: none;"></div>

  <div class="debug-panel" id="debugPanel"></div>

  <div id="score"></div>
</div>

<script>
/* =========================
   CONFIGURA√á√ÉO GLOBAL
========================= */

const SOLFEJO_PT = ["D√≥", "R√©", "Mi", "F√°", "Sol", "L√°", "Si"];

// Convers√£o MIDI para Frequ√™ncia (padr√£o internacional)
function midiToFrequency(midi, tuning = 440) {
  return tuning * Math.pow(2, (midi - 69) / 12);
}

// Converter nota musical para MIDI number
function noteToMidi(step, octave, alter = 0) {
  const noteOffsets = [0, 2, 4, 5, 7, 9, 11]; // C D E F G A B
  const baseNote = noteOffsets[step];
  const midiNumber = (octave + 1) * 12 + baseNote + alter;
  return midiNumber;
}

let osmd = null;
let timeline = [];
let isPlaying = false;
let stopRequested = false;

// Configura√ß√µes
let settings = {
  bpm: 80,
  volume: 0.7,
  tuning: 440,
  speechRate: 1.0
};

// S√≠ntese
let synth = null;

// Debug
let debugLog = [];

function addDebug(msg) {
  console.log(msg);
  debugLog.push(msg);
  const panel = document.getElementById("debugPanel");
  panel.innerHTML = debugLog.slice(-15).join("<br>");
}

/* =========================
   INICIALIZA√á√ÉO
========================= */

async function init() {
  try {
    osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("score", {
      drawTitle: true,
      autoResize: true,
      backend: "svg"
    });

    setupEventListeners();
    setStatus("‚úÖ Sistema inicializado. Carregue uma partitura MusicXML.");
    addDebug("Sistema inicializado com sucesso");
  } catch (err) {
    console.error("Erro na inicializa√ß√£o:", err);
    setStatus("‚ùå Erro ao inicializar o sistema.");
  }
}

/* =========================
   EVENT LISTENERS
========================= */

function setupEventListeners() {
  document.getElementById("fileInput").addEventListener("change", handleFileUpload);
  document.getElementById("playBtn").addEventListener("click", playTimeline);
  document.getElementById("stopBtn").addEventListener("click", stopPlayback);

  document.getElementById("bpmSlider").addEventListener("input", (e) => {
    settings.bpm = parseInt(e.target.value);
    document.getElementById("bpmValue").textContent = settings.bpm;
  });

  document.getElementById("volumeSlider").addEventListener("input", (e) => {
    settings.volume = parseInt(e.target.value) / 100;
    document.getElementById("volumeValue").textContent = e.target.value;
  });

  document.getElementById("tuningInput").addEventListener("input", (e) => {
    settings.tuning = parseInt(e.target.value);
    document.getElementById("tuningValue").textContent = settings.tuning;
  });

  document.getElementById("rateSlider").addEventListener("input", (e) => {
    settings.speechRate = parseFloat(e.target.value);
    document.getElementById("rateValue").textContent = e.target.value;
  });
}

/* =========================
   UPLOAD E PARSE
========================= */

async function handleFileUpload(e) {
  const file = e.target.files[0];
  if (!file) return;

  setStatus("üìñ Carregando partitura...");
  resetPlayer();
  debugLog = [];

  const text = await file.text();

  try {
    await osmd.load(text);
    await osmd.render();

    setStatus("üéº Processando partitura...");
    addDebug("Partitura carregada e renderizada");

    await new Promise(resolve => setTimeout(resolve, 300));

    buildTimeline();
  } catch (err) {
    console.error("Erro ao carregar MusicXML:", err);
    setStatus("‚ùå Erro ao carregar o arquivo: " + err.message);
    addDebug("ERRO: " + err.message);
  }
}

/* =========================
   CONSTRU√á√ÉO DA TIMELINE
========================= */

function buildTimeline() {
  timeline = [];
  addDebug("=== INICIANDO PARSE DA PARTITURA ===");

  try {
    const sheet = osmd.Sheet;

    if (!sheet || !sheet.Instruments || sheet.Instruments.length === 0) {
      throw new Error("Nenhum instrumento encontrado na partitura");
    }

    addDebug(`Instrumentos encontrados: ${sheet.Instruments.length}`);

    // Itera por todos os instrumentos
    sheet.Instruments.forEach((instrument, instrIdx) => {
      addDebug(`Processando instrumento ${instrIdx + 1}: ${instrument.Name}`);

      // Itera por todas as pautas (staves)
      instrument.Staves.forEach((staff, staffIdx) => {
        addDebug(`  Pauta ${staffIdx + 1}`);

        // Itera por todas as vozes
        staff.Voices.forEach((voice, voiceIdx) => {
          addDebug(`    Voz ${voiceIdx + 1} - ${voice.VoiceEntries.length} entradas`);

          // Itera por todas as entradas de voz
          voice.VoiceEntries.forEach((entry, entryIdx) => {

            // Pegar dura√ß√£o
            const duration = entry.Length ? entry.Length.RealValue : 1;

            // Verificar se √© pausa
            if (!entry.Notes || entry.Notes.length === 0) {
              timeline.push({
                type: "rest",
                duration: duration
              });
              addDebug(`      [${entryIdx}] PAUSA (dur: ${duration.toFixed(2)})`);
              return;
            }

            // Processar notas
            entry.Notes.forEach((note, noteIdx) => {
              if (!note || !note.Pitch) {
                addDebug(`      [${entryIdx}.${noteIdx}] Nota sem pitch, pulando`);
                return;
              }

              const pitch = note.Pitch;
              const step = pitch.FundamentalNote; // 0-6
              const octave = pitch.Octave;

              // Pegar altera√ß√£o (sustenido/bemol)
              let alter = 0;
              if (pitch.Accidental) {
                alter = pitch.Accidental;
              } else if (pitch.Alter) {
                alter = pitch.Alter;
              }

              const solfejo = SOLFEJO_PT[step];
              const midi = noteToMidi(step, octave, alter);
              const frequency = midiToFrequency(midi, 440);

              const noteData = {
                type: "note",
                text: solfejo,
                duration: duration,
                frequency: frequency,
                midi: midi,
                octave: octave,
                step: step,
                alter: alter
              };

              timeline.push(noteData);

              const alterSymbol = alter > 0 ? "‚ôØ" : (alter < 0 ? "‚ô≠" : "");
              addDebug(
                `      [${entryIdx}.${noteIdx}] ${solfejo}${alterSymbol}${octave} ` +
                `(MIDI ${midi}, ${frequency.toFixed(2)} Hz, dur ${duration.toFixed(2)})`
              );
            });
          });
        });
      });
    });

    if (timeline.length === 0) {
      throw new Error("Nenhuma nota v√°lida encontrada");
    }

    addDebug(`=== PARSE COMPLETO: ${timeline.length} eventos ===`);
    displayTimelineInfo();
    enablePlay();

  } catch (e) {
    console.error("Erro ao processar partitura:", e);
    setStatus("‚ùå Erro ao processar: " + e.message);
    addDebug("ERRO NO PARSE: " + e.message);
  }
}

/* =========================
   DISPLAY DE INFORMA√á√ïES
========================= */

function displayTimelineInfo() {
  const noteCount = timeline.filter(e => e.type === "note").length;
  const restCount = timeline.filter(e => e.type === "rest").length;
  const totalDuration = timeline.reduce((sum, e) => sum + e.duration, 0);

  const infoDiv = document.getElementById("timelineInfo");
  infoDiv.style.display = "block";
  infoDiv.innerHTML = `
    üìä <strong>${timeline.length}</strong> eventos |
    üéµ <strong>${noteCount}</strong> notas |
    üîá <strong>${restCount}</strong> pausas |
    ‚è±Ô∏è Dura√ß√£o: <strong>${totalDuration.toFixed(2)}</strong> tempos
  `;

  setStatus(`‚úÖ Partitura processada! ${noteCount} notas prontas para reprodu√ß√£o.`);
}

/* =========================
   REPRODU√á√ÉO
========================= */

async function playTimeline() {
  if (isPlaying || timeline.length === 0) return;

  // Inicializar Tone.js
  await Tone.start();
  addDebug("=== INICIANDO REPRODU√á√ÉO ===");

  // Criar sintetizador
  synth = new Tone.PolySynth(Tone.Synth, {
    oscillator: {
      type: "sine"
    },
    envelope: {
      attack: 0.005,
      decay: 0.1,
      sustain: 0.3,
      release: 1
    }
  }).toDestination();

  synth.volume.value = Tone.gainToDb(settings.volume);

  isPlaying = true;
  stopRequested = false;
  document.getElementById("stopBtn").disabled = false;
  document.getElementById("currentNoteDisplay").style.display = "block";

  setStatus("‚ñ∂Ô∏è Reproduzindo solfejo...");

  const quarterNoteMs = (60000 / settings.bpm);
  addDebug(`BPM: ${settings.bpm}, Sem√≠nima: ${quarterNoteMs.toFixed(2)} ms`);

  for (let i = 0; i < timeline.length; i++) {
    if (stopRequested) break;

    const event = timeline[i];
    const durationMs = event.duration * quarterNoteMs;

    if (event.type === "note") {
      const tuningRatio = settings.tuning / 440;
      const adjustedFreq = event.frequency * tuningRatio;

      const alterSymbol = event.alter > 0 ? "‚ôØ" : (event.alter < 0 ? "‚ô≠" : "");
      document.getElementById("noteText").textContent = event.text + alterSymbol;
      document.getElementById("noteDetails").textContent =
        `${event.octave}¬™ oitava | MIDI ${event.midi} | ${adjustedFreq.toFixed(2)} Hz`;

      // Tocar som
      synth.triggerAttackRelease(adjustedFreq, durationMs / 1000);

      // Falar solfejo
      speakSolfejo(event.text);

      addDebug(`‚ñ∂ ${event.text}${alterSymbol}${event.octave} - ${adjustedFreq.toFixed(2)} Hz por ${durationMs.toFixed(0)} ms`);

    } else {
      document.getElementById("noteText").textContent = "‚Äî";
      document.getElementById("noteDetails").textContent = "Pausa";
      addDebug(`‚ñ∂ PAUSA - ${durationMs.toFixed(0)} ms`);
    }

    await wait(durationMs);
  }

  addDebug("=== REPRODU√á√ÉO FINALIZADA ===");
  stopPlayback();
}

/* =========================
   S√çNTESE DE VOZ
========================= */

function speakSolfejo(text) {
  try {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = "pt-BR";
    utterance.rate = settings.speechRate;
    utterance.pitch = 1.2;
    utterance.volume = settings.volume;

    speechSynthesis.cancel();
    speechSynthesis.speak(utterance);
  } catch (e) {
    console.warn("Erro na s√≠ntese de voz:", e);
  }
}

/* =========================
   CONTROLE
========================= */

function stopPlayback() {
  stopRequested = true;
  isPlaying = false;

  if (synth) {
    synth.releaseAll();
    synth.dispose();
    synth = null;
  }

  speechSynthesis.cancel();

  document.getElementById("stopBtn").disabled = true;
  document.getElementById("currentNoteDisplay").style.display = "none";

  setStatus("‚èπÔ∏è Reprodu√ß√£o parada.");
  addDebug("Reprodu√ß√£o parada pelo usu√°rio");
}

function resetPlayer() {
  stopPlayback();
  timeline = [];
  document.getElementById("playBtn").disabled = true;
  document.getElementById("timelineInfo").style.display = "none";
}

function enablePlay() {
  document.getElementById("playBtn").disabled = false;
}

function wait(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

function setStatus(msg) {
  document.getElementById("status").innerHTML = msg;
}

/* =========================
   INICIAR
========================= */

init();
</script>

</body>
</html>
