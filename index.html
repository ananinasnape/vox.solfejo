<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VoxSolfejo</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/opensheetmusicdisplay@1.8.5/build/opensheetmusicdisplay.min.js"></script>

<style>
body { background:#0f172a; color:white; }
button { touch-action: manipulation; }
</style>
</head>

<body class="p-4 max-w-4xl mx-auto space-y-4">

<h1 class="text-2xl font-black text-center">ðŸŽ¶ VoxSolfejo</h1>

<input type="file" id="fileInput" accept=".xml,.musicxml"
  class="block w-full text-sm mb-2">

<div class="flex gap-3">
  <button id="testSound" class="bg-green-600 px-4 py-2 rounded font-bold">
    ðŸ”Š TESTAR SOM
  </button>

  <button id="playBtn" class="bg-indigo-600 px-4 py-2 rounded font-bold">
    â–¶ PLAY
  </button>
</div>

<div class="flex gap-4 text-sm">
  <label>BPM
    <input type="range" id="bpm" min="40" max="200" value="80">
    <span id="bpmVal">80</span>
  </label>
</div>

<div id="score" class="bg-white text-black rounded-xl p-3"></div>

<script>
/* ================= AUDIO ================= */
let audioCtx = null;

/* ================= TEST SOUND ================= */
document.getElementById("testSound").onclick = async () => {
  if (!audioCtx) audioCtx = new AudioContext();
  await audioCtx.resume();

  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  osc.frequency.value = 440;
  gain.gain.value = 0.4;

  osc.connect(gain).connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + 0.4);
};

/* ================= OSMD ================= */
const osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("score", {
  autoResize: true,
  drawTitle: false
});

let queue = [];

const SOLFEJO = ['DÃ³','RÃ©','Mi','FÃ¡','Sol','LÃ¡','Si'];
const REF = [-9,-7,-5,-4,-2,0,2];

/* ================= LOAD XML ================= */
document.getElementById("fileInput").onchange = async e => {
  const file = e.target.files[0];
  if (!file) return;

  await osmd.load(await file.text());
  osmd.render();
  extrairNotasCorretamente();
};

/* ================= EXTRAÃ‡ÃƒO CORRETA ================= */
function extrairNotasCorretamente() {
  queue = [];

  const measures = osmd.Sheet.SourceMeasures;

  measures.forEach(measure => {
    measure.VerticalSourceStaffEntryContainers.forEach(v => {
      v.SourceStaffEntry?.VoiceEntries.forEach(ve => {
        const dur = ve.Duration?.RealValue || 0;

        ve.Notes.forEach(n => {
          if (!n.Pitch) return;

          queue.push({
            letra: n.Pitch.FundamentalNote,
            oitava: n.Pitch.Octave,
            acidente: n.Pitch.Accidental || 0,
            dur
          });
        });
      });
    });
  });

  console.log("Notas extraÃ­das:", queue.length);
}

/* ================= FREQUÃŠNCIA ================= */
function freq(n) {
  return 440 * Math.pow(
    2,
    (REF[n.letra] + (n.oitava - 4) * 12 + n.acidente) / 12
  );
}

/* ================= PLAY ================= */
document.getElementById("playBtn").onclick = async () => {
  if (!queue.length) {
    alert("Partitura carregada, mas sem notas executÃ¡veis.");
    return;
  }

  if (!audioCtx) audioCtx = new AudioContext();
  await audioCtx.resume();

  const bpm = +document.getElementById("bpm").value;

  for (const n of queue) {
    const tempo = n.dur * (60 / bpm) * 4;

    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    osc.type = "triangle";
    osc.frequ
