<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VoxSolfejo Maestro AI - Final 2026</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net"></script>
    <script src="https://cdn.jsdelivr.net"></script>

    <style>
        @import url('https://fonts.googleapis.com');
        body { font-family: 'Inter', sans-serif; background: #0F172A; color: #F1F5F9; margin: 0; padding: 0; }
        .glass { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); }
        input[type=range] { accent-color: #6366F1; cursor: pointer; }
        #osmdCanvas { background: white; border-radius: 1.5rem; color: black; min-height: 400px; }
        .inst-btn.active { background-color: #4F46E5; color: white; border-color: #818CF8; }
        textarea { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); resize: none; color: #818CF8; }
        textarea:focus { border-color: #4F46E5; outline: none; }
    </style>
</head>
<body class="p-2 md:p-6 min-h-screen">

    <div class="max-w-7xl mx-auto space-y-4">
        <!-- Header -->
        <header class="glass rounded-3xl p-6 flex flex-col md:flex-row justify-between items-center gap-4 shadow-2xl">
            <div class="text-center md:text-left">
                <h1 class="text-2xl font-black italic text-indigo-400 tracking-tighter">VOXSOLFEJO MAESTRO 2026</h1>
                <p class="text-[10px] font-bold opacity-60 uppercase tracking-widest leading-none">Voz ‚Ä¢ Violino ‚Ä¢ Flauta ‚Ä¢ Piano | 440Hz Precision</p>
            </div>
            <div class="flex gap-2">
                <label class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2.5 rounded-full font-bold cursor-pointer transition shadow-lg text-[10px] uppercase">
                    üìÅ Importar PDF/XML
                    <input type="file" id="fileInput" class="hidden" accept=".xml,.musicxml,.mxl,.pdf">
                </label>
                <button id="exportWav" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2.5 rounded-full font-bold text-[10px] uppercase">Gravar .WAV</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
            <!-- Esquerda: Editor e Monitor -->
            <div class="lg:col-span-3 space-y-4">
                <div class="glass rounded-3xl p-6 shadow-xl border-t-4 border-indigo-500">
                    <div class="text-center mb-6">
                        <span class="text-[10px] font-black opacity-40 uppercase">Monitor Vocal</span>
                        <div id="vocalLabel" class="text-6xl font-black text-white py-2 tracking-tighter">--</div>
                        <div id="hzLabel" class="text-indigo-400 font-mono text-[10px]">A4 = 440.00 Hz</div>
                    </div>
                    <label class="text-[10px] font-bold opacity-40 uppercase block mb-2">Editor (Cursor Ativo)</label>
                    <textarea id="textoInput" class="w-full h-40 p-4 rounded-2xl text-xl font-mono" placeholder="Ex: C D E...">C D E F G A B</textarea>
                    <button id="processText" class="w-full mt-2 py-3 bg-indigo-500/10 hover:bg-indigo-500/30 text-indigo-300 rounded-xl font-bold text-[10px] uppercase tracking-widest transition">Interpretar Texto</button>
                </div>

                <div class="glass rounded-3xl p-4 flex flex-wrap justify-around gap-2">
                    <button onclick="setMode('vocal')" id="m-vocal" class="inst-btn active text-[9px] font-black uppercase px-3 py-2 rounded-lg border border-transparent">Voz</button>
                    <button onclick="setMode('violino')" id="m-violino" class="inst-btn text-[9px] font-black uppercase px-3 py-2 rounded-lg border border-transparent">Violino</button>
                    <button onclick="setMode('flauta')" id="m-flauta" class="inst-btn text-[9px] font-black uppercase px-3 py-2 rounded-lg border border-transparent">Flauta</button>
                    <button onclick="setMode('piano')" id="m-piano" class="inst-btn text-[9px] font-black uppercase px-3 py-2 rounded-lg border border-transparent">Piano</button>
                </div>
            </div>

            <!-- Centro: Visualizador -->
            <div class="lg:col-span-6 glass rounded-[2.5rem] p-4 shadow-2xl overflow-hidden">
                <div id="osmdCanvas" class="w-full h-[600px] overflow-auto">
                    <div id="loaderMsg" class="h-full flex items-center justify-center text-slate-500 italic text-sm">Carregue um arquivo para visualizar a partitura...</div>
                </div>
            </div>

            <!-- Direita: Controles -->
            <div class="lg:col-span-3 space-y-4">
                <div class="glass rounded-3xl p-6 space-y-6">
                    <h3 class="text-[10px] font-black opacity-40 uppercase tracking-[0.2em] border-b border-white/5 pb-2">Ajustes Maestros</h3>
                    <div>
                        <div class="flex justify-between text-[10px] font-bold mb-2"><span>VELOCIDADE (BPM)</span> <span id="bpmVal" class="text-indigo-400">80</span></div>
                        <input type="range" id="bpmRange" min="20" max="220" value="80" class="w-full">
                    </div>
                    <div>
                        <div class="flex justify-between text-[10px] font-bold mb-2"><span>TRANSPOSI√á√ÉO</span> <span id="transpVal" class="text-indigo-400">0</span></div>
                        <input type="range" id="transpRange" min="-12" max="12" value="0" class="w-full">
                    </div>
                    <div>
                        <div class="flex justify-between text-[10px] font-bold mb-2"><span>CALIBRA√á√ÉO HZ</span> <span id="calibVal" class="text-indigo-400">440Hz</span></div>
                        <input type="range" id="calibRange" min="415" max="466" value="440" class="w-full">
                    </div>
                    <div class="flex items-center gap-3 pt-2">
                        <input type="checkbox" id="vibratoToggle" checked class="w-4 h-4 accent-indigo-500">
                        <span class="text-[9px] font-black uppercase opacity-60">Vibrato Humano</span>
                    </div>
                </div>

                <div class="flex flex-col gap-3">
                    <button id="playBtn" class="w-full py-6 bg-indigo-600 hover:bg-indigo-500 text-white rounded-[2rem] font-black text-2xl shadow-xl shadow-indigo-900/50 active:scale-95 transition-all">PLAY</button>
                    <button id="stopBtn" class="w-full py-4 bg-slate-800 text-slate-500 rounded-2xl font-bold uppercase text-[9px] tracking-widest">Parar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const PITCH_DATA = { 'C': -9, 'D': -7, 'E': -5, 'F': -4, 'G': -2, 'A': 0, 'B': 2 };
        const SYLLABLES = { 'C': 'D√≥', 'D': 'R√©', 'E': 'Mi', 'F': 'F√°', 'G': 'Sol', 'A': 'L√°', 'B': 'Si' };
        
        let audioCtx, osmd, musicalQueue = [], isPlaying = false, currentMode = 'vocal';
        let streamDest, mediaRecorder, chunks = [];

        // Inicializa o OSMD ap√≥s garantir que a biblioteca carregou
        window.onload = () => {
            osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("osmdCanvas", { autoResize: true, drawTitle: false });
        };

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.inst-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`m-${mode}`).classList.add('active');
        }

        async function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                streamDest = audioCtx.createMediaStreamDestination();
            }
            if (audioCtx.state === 'suspended') await audioCtx.resume();
        }

        // Leitura de Arquivo
        document.getElementById('fileInput').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                document.getElementById('loaderMsg').style.display = 'none';
                await osmd.load(ev.target.result);
                osmd.render();
                parseData();
            };
            reader.readAsText(file);
        };

        function parseData() {
            musicalQueue = [];
            osmd.GraphicSheet.MusicPages.forEach(p => p.MusicSystems.forEach(s => s.StaffLines.forEach(l => l.Measures.forEach(m => m.StaffEntries.forEach(e => {
                const sn = e.ModelStaffEntry.sourceNotes;
                const dur = e.ModelStaffEntry.Duration.RealValue;
                if (sn && sn.length > 0) {
                    const pitch = sn[0].Pitch;
                    musicalQueue.push({ letra: "CDEFGAB"[pitch.fundamentalPitch], oitava: pitch.octave + 3, dur: dur, tipo: 'nota' });
                } else { musicalQueue.push({ dur: dur, tipo: 'pausa' }); }
            })))));
        }

        function synthesize(item, tempoReal) {
            const baseHz = parseInt(document.getElementById('calibRange').value);
            const transp = parseInt(document.getElementById('transpRange').value);
            const semitones = PITCH_DATA[item.letra] + (item.oitava - 4) * 12 + transp;
            const freq = baseHz * Math.pow(2, semitones / 12);

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            let attack = 0.05, release = 0.1, wave = 'sawtooth';

            if (currentMode === 'violino') { wave = 'sawtooth'; attack = 0.1; }
            if (currentMode === 'flauta') { wave = 'sine'; attack = 0.07; }
            if (currentMode === 'piano') { wave = 'triangle'; attack = 0.005; release = 0.8; }
            if (currentMode === 'vocal') {
                const utterance = new SpeechSynthesisUtterance(SYLLABLES[item.letra]);
                utterance.lang = 'pt-BR'; utterance.rate = 1.2;
                window.speechSynthesis.speak(utterance);
            }

            osc.type = wave;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);

            if (document.getElementById('vibratoToggle').checked) {
                const lfo = audioCtx.createOscillator();
                const lfoG = audioCtx.createGain();
                lfo.frequency.value = 5.5; lfoG.gain.value = freq * 0.01;
                lfo.connect(lfoG); lfoG.connect(osc.frequency);
                lfo.start();
            }

            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.4, audioCtx.currentTime + attack);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + tempoReal + release);

            document.getElementById('vocalLabel').innerText = SYLLABLES[item.letra];
            document.getElementById('hzLabel').innerText = freq.toFixed(2) + " Hz";

            osc.connect(gain); gain.connect(audioCtx.destination);
            gain.connect(streamDest);
            osc.start(); osc.stop(audioCtx.currentTime + tempoReal + release);
        }

        async function start() {
            if (isPlaying || musicalQueue.length === 0) return;
            await initAudio();
            isPlaying = true;
            const bpm = document.getElementById('bpmRange').value;
            const step = (60/bpm)*4;

            for (let item of musicalQueue) {
                if (!isPlaying) break;
                const d = item.dur * step;
                if (item.tipo === 'nota') synthesize(item, d);
                else document.getElementById('vocalLabel').innerText = "‚Äî";
                await new Promise(r => setTimeout(r, d * 1000));
            }
            isPlaying = false;
        }

        document.getElementById('playBtn').onclick = start;
        document.getElementById('stopBtn').onclick = () => { isPlaying = false; window.speechSynthesis.cancel(); };
        document.getElementById('bpmRange').oninput = (e) => document.getElementById('bpmVal').innerText = e.target.value;
        document.getElementById('transpRange').oninput = (e) => document.getElementById('transpVal').innerText = e.target.value;
        document.getElementById('calibRange').oninput = (e) => document.getElementById('calibVal').innerText = e.target.value + "Hz";
        document.getElementById('processText').onclick = () => {
            const raw = document.getElementById('textoInput').value.toUpperCase().match(/[A-G]/g);
            if (raw) {
                musicalQueue = raw.map(n => ({ letra: n, oitava: 4, dur: 1, tipo: 'nota' }));
                alert("Notas carregadas do editor!");
            }
        };

        document.getElementById('exportWav').onclick = async () => {
            await initAudio();
            chunks = [];
            mediaRecorder = new MediaRecorder(streamDest.stream);
            mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
            mediaRecorder.onstop = () => {
                const b = new Blob(chunks, { type: 'audio/wav' });
                const u = URL.createObjectURL(b);
                const a = document.createElement('a'); a.href = u; a.download = "solfejo.wav"; a.click();
            };
            mediaRecorder.start();
            await start();
            setTimeout(() => mediaRecorder.stop(), 500);
        };
    </script>
</body>
</html>
