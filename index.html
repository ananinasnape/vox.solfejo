<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>VoxSolfejo</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/opensheetmusicdisplay@1.8.5/build/opensheetmusicdisplay.min.js"></script>

<style>
body { background:#0f172a; color:white; }
button { touch-action: manipulation; }
</style>
</head>

<body class="p-4 max-w-4xl mx-auto space-y-4">

<header class="text-center space-y-1">
  <h1 class="text-2xl font-black">ðŸŽ¶ VoxSolfejo</h1>
  <p class="text-xs opacity-70">Solfejo vocal respeitando a partitura</p>
</header>

<section class="flex flex-col sm:flex-row gap-3">
  <input type="file" id="fileInput" accept=".musicxml,.xml,.mxl"
    class="block w-full text-sm" />
  <button id="playBtn"
    class="bg-indigo-600 px-6 py-3 rounded-xl font-bold">
    â–¶ PLAY
  </button>
</section>

<section class="flex gap-4 text-sm">
  <label>BPM
    <input type="range" id="bpm" min="30" max="200" value="80">
    <span id="bpmVal">80</span>
  </label>
  <label>AfinaÃ§Ã£o
    <input type="range" id="hz" min="415" max="466" value="440">
    <span id="hzVal">440</span>Hz
  </label>
</section>

<div id="score" class="bg-white rounded-xl p-3 text-black"></div>

<script>
const osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("score", {
  autoResize: true,
  drawTitle: false
});

let queue = [];
let audioCtx;

const NOTAS = ['C','D','E','F','G','A','B'];
const SOLFEJO = {C:'DÃ³',D:'RÃ©',E:'Mi',F:'FÃ¡',G:'Sol',A:'LÃ¡',B:'Si'};
const REF = {C:-9,D:-7,E:-5,F:-4,G:-2,A:0,B:2};

document.getElementById("fileInput").onchange = async e => {
  const file = e.target.files[0];
  if (!file) return;
  await osmd.load(await file.text());
  osmd.render();
  extrairNotas();
};

function extrairNotas() {
  queue = [];
  const sheet = osmd.GraphicSheet;
  sheet.MusicPages.forEach(p =>
    p.MusicSystems.forEach(sys =>
      sys.StaffLines.forEach(staff =>
        staff.Measures.forEach(m =>
          m.StaffEntries.forEach(se => {
            const src = se.ModelStaffEntry;
            const dur = src.Duration?.RealValue || 0;
            if (!src.sourceNotes?.length) {
              queue.push({tipo:'pausa', dur});
              return;
            }
            const n = src.sourceNotes[0];
            queue.push({
              tipo:'nota',
              letra: NOTAS[n.Pitch.fundamentalPitch],
              oitava: n.Pitch.octave + 3,
              acidente: n.Pitch.accidental || 0,
              dur
            });
          })
        )
      )
    )
  );
}

function freq(letra, oit, acc) {
  const base = +document.getElementById("hz").value;
  let s = REF[letra] + (oit-4)*12 + acc;
  return base * Math.pow(2, s/12);
}

async function cantar(item, tempo) {
  if (!audioCtx) audioCtx = new AudioContext();
  await audioCtx.resume();

  if (item.tipo === 'pausa') {
    return new Promise(r => setTimeout(r, tempo*1000));
  }

  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  osc.type = "triangle"; // mais vocal
  osc.frequency.value = freq(item.letra,item.oitava,item.acidente);

  gain.gain.setValueAtTime(0, audioCtx.currentTime);
  gain.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime+0.05);
  gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime+tempo);

  osc.connect(gain).connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime+tempo);

  const fala = new SpeechSynthesisUtterance(SOLFEJO[item.letra]);
  fala.lang = "pt-BR";
  fala.rate = 1.1;
  speechSynthesis.speak(fala);

  return new Promise(r => setTimeout(r, tempo*1000));
}

document.getElementById("playBtn").onclick = async () => {
  const bpm = +document.getElementById("bpm").value;
  for (const n of queue) {
    const tempo = n.dur * (60/bpm) * 4;
    await cantar(n, tempo);
  }
};

["bpm","hz"].forEach(id =>
  document.getElementById(id).oninput = e =>
    document.getElementById(id+"Val").textContent = e.target.value
);
</script>

</body>
</html>
