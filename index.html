<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Vox Solfejo Maestro</title>

<script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.8.9/build/opensheetmusicdisplay.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #0f172a;
  color: #e5e7eb;
  padding: 20px;
}

h1 { margin-bottom: 8px; }

.controls {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 10px;
}

button { padding: 6px 14px; }
button:disabled { opacity: .4; }

label { font-size: 14px; }

#status { margin: 8px 0; }

#score {
  background: white;
  border-radius: 6px;
  margin-top: 10px;
}

#log {
  background: #020617;
  border-radius: 6px;
  padding: 10px;
  margin-top: 10px;
  font-family: monospace;
  font-size: 13px;
  max-height: 220px;
  overflow-y: auto;
}
</style>
</head>

<body>

<h1>üé∂ Vox Solfejo Maestro</h1>

<div class="controls">
  <input type="file" id="fileInput" accept=".xml,.musicxml,.mxl">

  <label>BPM:
    <input type="number" id="bpmInput" value="80" min="30" max="240">
  </label>

  <label>A4 (Hz):
    <input type="number" id="hzInput" value="440" min="430" max="450">
  </label>

  <button id="playBtn" disabled>‚ñ∂ Play</button>
  <button id="pauseBtn" disabled>‚è∏</button>
  <button id="stopBtn" disabled>‚èπ</button>
</div>

<div id="status">Carregue um MusicXML.</div>
<div id="score"></div>
<div id="log"></div>

<script>
const fileInput = document.getElementById("fileInput");
const playBtn  = document.getElementById("playBtn");
const pauseBtn = document.getElementById("pauseBtn");
const stopBtn  = document.getElementById("stopBtn");
const statusEl = document.getElementById("status");
const bpmInput = document.getElementById("bpmInput");
const hzInput  = document.getElementById("hzInput");
const logEl    = document.getElementById("log");

let osmd, events=[], divisions=4;
let idx=0, playing=false, paused=false, timer=null;
let audioCtx = new (window.AudioContext||window.webkitAudioContext)();

const SOLFEJO = {C:"D√≥",D:"R√©",E:"Mi",F:"F√°",G:"Sol",A:"L√°",B:"Si"};
const SEMITONS = {C:-9,D:-7,E:-5,F:-4,G:-2,A:0,B:2};

fileInput.onchange = loadFile;
playBtn.onclick = play;
pauseBtn.onclick = pause;
stopBtn.onclick = stop;

function loadFile(e){
  const f=e.target.files[0];
  if(!f) return;
  const r=new FileReader();
  r.onload=()=>loadScore(r.result);
  r.readAsText(f);
}

async function loadScore(xml){
  playBtn.disabled=true;
  if(!osmd) osmd=new opensheetmusicdisplay.OpenSheetMusicDisplay("score");
  await osmd.load(xml);
  osmd.render();
  parseXML(xml);
  if(events.length){
    statusEl.textContent="Pronto.";
    playBtn.disabled=pauseBtn.disabled=stopBtn.disabled=false;
  }
}

function parseXML(txt){
  events=[]; idx=0; logEl.textContent="";
  const xml=new DOMParser().parseFromString(txt,"application/xml");
  divisions=parseInt(xml.querySelector("divisions")?.textContent||4);

  xml.querySelectorAll("note").forEach(n=>{
    const dur=parseInt(n.querySelector("duration")?.textContent||0);
    if(n.querySelector("rest")){
      events.push({type:"rest",dur});
      return;
    }
    const step=n.querySelector("step")?.textContent;
    const oct=parseInt(n.querySelector("octave")?.textContent);
    const alter=parseInt(n.querySelector("alter")?.textContent||0);
    if(step) events.push({type:"note",step,oct,alter,dur});
  });
}

function freq(step,oct,alter){
  const a4=parseFloat(hzInput.value);
  const sem=SEMITONS[step]+alter+(oct-4)*12;
  return +(a4*Math.pow(2,sem/12)).toFixed(2);
}

function play(){
  if(playing) return;
  playing=true; paused=false;
  audioCtx.resume();
  next();
}

function pause(){
  paused=true; playing=false;
  clearTimeout(timer);
  speechSynthesis.cancel();
}

function stop(){
  playing=false; paused=false; idx=0;
  clearTimeout(timer);
  speechSynthesis.cancel();
}

function next(){
  if(!playing||paused||idx>=events.length){
    playing=false; return;
  }
  const ev=events[idx++];
  const bpm=parseFloat(bpmInput.value);
  const ms=(60/bpm)*(ev.dur/divisions)*1000;

  if(ev.type==="note"){
    const f=freq(ev.step,ev.oct,ev.alter);
    const osc=audioCtx.createOscillator();
    const g=audioCtx.createGain();
    osc.frequency.value=f;
    g.gain.value=0.15;
    osc.connect(g).connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime+ms/1000);

    const nome=SOLFEJO[ev.step]+(ev.alter===1?"‚ôØ":ev.alter===-1?"‚ô≠":"")+ev.oct;
    logEl.textContent+=`‚ñ∂ ${nome} - ${f} Hz por ${Math.round(ms)} ms\n`;
    logEl.scrollTop=logEl.scrollHeight;

    speechSynthesis.speak(new SpeechSynthesisUtterance(SOLFEJO[ev.step]));
  }

  timer=setTimeout(next,ms);
}
</script>
</body>
</html>
